# 用户协议功能对齐文档 (ALIGNMENT)

## 1. 项目上下文分析

- **技术栈**: NestJS (Monorepo), Prisma ORM, PostgreSQL.
- **结构**:
  - `apps/app-api`: 面向移动端/前端用户的 API。
  - `apps/admin-api`: 面向管理后台的 API。
  - `libs/base`: 包含 Prisma Client 和基础服务。
  - `libs/app-config`: 适合存放协议相关的业务逻辑（类似于 `notice`, `page`）。
- **现有模式**:
  - 数据表定义在 `prisma/models` 目录下按模块分类。
  - 核心业务逻辑封装在 `libs` 中，通过 Controller 暴露给不同的 App。

## 2. 需求理解与确认

### 原始需求
- 参考项目规范，开发用户协议相关功能。
- 主体功能在 `libs` 中。
- App 端和 Admin 端均需暴露接口。
- **当前阶段**: 先设计数据表，确认后再进行后续开发。

### 核心功能推导
虽然用户未详细列出功能点，但标准的用户协议模块通常包含：
1. **协议管理 (Admin)**:
   - 创建、编辑、发布协议（隐私政策、服务条款等）。
   - 版本管理（如 v1.0, v1.1）。
   - 查看协议的历史版本。
2. **协议展示 (App)**:
   - 获取最新版本的协议内容。
   - 获取指定类型的协议（如注册页只看服务条款）。
3. **签署记录 (Log)**:
   - 记录用户同意协议的时间、版本、IP 等信息（合规性要求）。

## 3. 智能决策策略

- **表结构设计**: 采用 "协议定义表" + "签署记录表" 的双表设计。
- **模块位置**: 建议在 `libs/app-config` 下新增 `agreement` 模块，复用现有的 config/notice 模式。

## 4. 关键决策点 (需确认)

- **多语言支持**: 当前设计暂不包含多语言字段（基于现有 `AppPage` 和 `AppNotice` 也未显式看到 i18n 结构），如果需要支持多语言，表结构需调整。**假设：暂时只支持单语言，或内容中包含多语言。**
- **强制签署**: 签署记录表主要用于审计。是否强制用户重新签署（弹窗阻断）通常由前端结合 API 返回的 "最新版本号" 与 "用户上次签署版本号" 对比决定。

## 5. 下一步计划

1. 提交数据表设计方案 (DESIGN 文档)。
2. 等待用户确认数据表。
