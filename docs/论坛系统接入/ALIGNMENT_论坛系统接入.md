# 论坛系统接入 - 需求对齐文档

## 1. 项目上下文分析

### 1.1 现有项目技术栈

- **后端框架**: NestJS 11.x
- **HTTP 服务器**: Fastify 5.x
- **ORM**: Prisma 7.x
- **数据库**: PostgreSQL
- **编程语言**: TypeScript 5.x
- **缓存**: Redis (cache-manager + keyv)
- **认证**: JWT + Passport
- **API 文档**: Swagger
- **日志**: Winston
- **文件上传**: Fastify Multipart
- **安全**: Fastify Helmet, CSRF Protection, @nestjs/throttler

### 1.2 现有项目架构

#### 目录结构
```
es-server/
├── apps/
│   ├── admin-api/          # 管理后台 API
│   └── client-api/         # 客户端 API
├── libs/                   # 共享库
│   ├── base/              # 基础库（数据库、工具、装饰器等）
│   ├── auth/              # 认证模块
│   ├── cache/             # 缓存模块
│   ├── client-config/     # 客户端配置
│   ├── dictionary/        # 数据字典
│   ├── member/            # 会员模块
│   └── upload/            # 上传模块
├── prisma/
│   ├── models/            # 数据模型定义
│   │   ├── admin/         # 管理员相关
│   │   ├── client/        # 客户用户相关
│   │   ├── work/          # 内容管理相关（漫画）
│   │   └── system/        # 系统相关
│   └── migrations/        # 数据库迁移
└── package.json
```

#### 模块设计模式
参考漫画模块（[comic.module.ts](file:///e:/Code/es/es-server/apps/admin-api/src/modules/content-management/comic/core/comic.module.ts)）的实现：

1. **分层架构**: Controller → Service → Repository
2. **模块化设计**: 每个功能独立成模块
3. **DTO 验证**: 使用 class-validator 进行数据验证
4. **API 文档**: 使用 @nestjs/swagger 自动生成文档
5. **数据库操作**: 继承 RepositoryService 复用通用方法
6. **软删除**: 支持 deletedAt 字段实现软删除
7. **事务处理**: 使用 Prisma 事务处理复杂操作
8. **路由规范**: 管理后台路由前缀为 `admin/模块名/子模块名`

#### 现有用户体系
- **AdminUser**: 管理员用户（后台管理）
- **ClientUser**: 客户端用户（前端用户）

### 1.3 现有漫画模块实现分析

#### 漫画模块结构
```
apps/admin-api/src/modules/content-management/comic/
├── core/                  # 漫画核心功能
│   ├── comic.module.ts
│   ├── comic.controller.ts
│   ├── comic.service.ts
│   ├── comic.constant.ts
│   └── dto/
│       └── comic.dto.ts
├── chapter/               # 章节管理
├── chapter-content/      # 章节内容
└── third-party/           # 第三方集成
```

#### 核心功能实现
- **CRUD 操作**: 创建、查询、更新、删除漫画
- **关联管理**: 作者、分类、标签的多对多关系
- **状态管理**: 发布状态、推荐状态、热门状态、新作状态
- **数据统计**: 点赞数、收藏数、浏览量、评分
- **分页查询**: 支持多条件筛选和分页
- **软删除**: 删除前检查关联数据

#### 数据模型设计
参考 [WorkComic](file:///e:/Code/es/es-server/prisma/models/work/comic/work-comic.prisma) 模型：
- 使用 Prisma schema 定义
- 支持软删除（deletedAt）
- 使用索引优化查询性能
- 多对多关系通过中间表实现
- 详细的字段注释

## 2. 原始需求

接入 [https://www.zibll.com/forums?index=2](https://www.zibll.com/forums?index=2) 网站论坛系统，要求：

1. **架构隔离改造**:
   - 设计独立的论坛模块目录结构，与漫画模块在代码层面完全分离
   - 实现独立的数据库表结构
   - 配置独立的路由前缀，避免与漫画模块路由冲突
   - 开发独立的权限控制系统，确保论坛用户权限与漫画模块权限体系隔离

2. **功能集成改造**:
   - 开发论坛内容展示、发布、评论、点赞等核心功能
   - 集成搜索功能，确保论坛内容搜索与漫画内容搜索相互独立
   - 实现通知系统，区分论坛相关通知与漫画模块通知

3. **社区最佳实践实施**:
   - 建立清晰的社区规则与版主管理制度
   - 实现内容审核机制，包括人工审核与AI辅助审核
   - 开发用户行为激励系统，如积分、等级、徽章体系
   - 设计合理的内容组织形式，如板块分类、标签体系
   - 集成数据分析功能，跟踪社区活跃度、用户行为等关键指标

4. **性能与安全优化**:
   - 实现论坛内容缓存策略，与漫画模块缓存机制分离
   - 配置独立的CDN资源，避免影响漫画模块加载速度
   - 加强论坛模块安全防护，防止XSS、CSRF等常见攻击
   - 实现防刷屏、反垃圾信息机制，维护社区环境健康

5. **可扩展性设计**:
   - 采用模块化架构，便于未来功能扩展
   - 设计插件机制，支持第三方功能扩展
   - 预留API接口，便于未来与其他系统集成

## 3. 需求理解

### 3.1 任务范围

**核心目标**: 在现有漫画平台基础上，独立接入一个完整的论坛社区系统

**关键约束**:
- 必须与现有漫画模块完全隔离（代码、数据库、路由、权限）
- 必须遵循现有项目架构和代码规范
- 必须参考漫画模块的实现方式
- 必须符合社区最佳实践

### 3.2 对现有项目的理解

#### 代码规范
1. **模块化设计**: 每个功能独立成模块，便于维护和扩展
2. **分层架构**: Controller（路由）→ Service（业务逻辑）→ Repository（数据访问）
3. **DTO 验证**: 使用 class-validator 进行请求数据验证
4. **装饰器使用**: 
   - `@ApiTags`: API 分组
   - `@ApiDoc`: 单个接口文档
   - `@ApiPageDoc`: 分页接口文档
   - `@Public`: 公开接口
5. **错误处理**: 使用 `BadRequestException` 等标准异常
6. **数据库操作**: 继承 `RepositoryService` 复用通用方法
7. **软删除**: 使用 `deletedAt` 字段，删除前检查关联数据
8. **事务处理**: 复杂操作使用 Prisma 事务保证数据一致性

#### 数据库设计规范
1. **命名规范**: 
   - 表名: 小写+下划线（如 `work_comic`）
   - 字段名: 小写+下划线（如 `created_at`）
   - 中间表: `表1_表2`（如 `work_comic_tag`）
2. **字段设计**:
   - 主键: `id` 自增
   - 时间字段: `created_at`, `updated_at` (Timestamptz)
   - 软删除: `deleted_at` (Timestamptz)
   - 状态字段: `is_enabled` (Boolean)
3. **索引优化**: 根据查询场景添加合适的索引
4. **关系设计**: 多对多关系通过中间表实现
5. **注释**: 使用 `///` 添加字段注释

#### 路由规范
- **管理后台**: `/admin/{模块名}/{子模块名}/{操作}`
  - 示例: `/admin/work/comic/create`
- **客户端**: `/client/{模块名}/{子模块名}/{操作}`
- **RESTful 风格**: 
  - GET: 查询
  - POST: 创建/更新
  - DELETE: 删除

### 3.3 社区最佳实践理解

基于对 [Zibll子比主题](https://www.zibll.com/forums?index=2) 的分析，社区论坛系统应包含：

#### 核心功能
1. **用户系统**: 注册、登录、个人中心、权限管理
2. **内容管理**: 帖子发布、编辑、删除、分类、标签
3. **互动功能**: 评论、点赞、收藏、分享
4. **搜索功能**: 全文搜索、高级搜索、热门搜索
5. **通知系统**: 站内通知、邮件通知、推送通知
6. **内容审核**: 人工审核、AI辅助审核、敏感词过滤

#### 社区管理
1. **板块管理**: 板块分类、版主管理、权限控制
2. **用户激励**: 积分系统、等级体系、徽章系统
3. **内容组织**: 热门推荐、最新发布、精华帖子
4. **数据分析**: 活跃度统计、用户行为分析、内容分析

#### 安全防护
1. **防刷机制**: 频率限制、验证码、IP限制
2. **内容安全**: XSS防护、CSRF防护、敏感词过滤
3. **数据安全**: 数据加密、备份恢复、日志审计

## 4. 边界确认

### 4.1 包含的功能

#### 第一阶段（核心功能）
1. **用户管理**: 论坛用户注册、登录、个人资料
2. **板块管理**: 板块分类、版主管理
3. **帖子管理**: 帖子发布、编辑、删除、查看
4. **评论系统**: 评论发布、回复、删除
5. **点赞功能**: 帖子点赞、评论点赞
6. **搜索功能**: 帖子搜索、用户搜索
7. **通知系统**: 评论通知、点赞通知

#### 第二阶段（社区功能）
1. **积分系统**: 积分获取、积分消费、积分记录
2. **等级系统**: 用户等级、等级权益
3. **徽章系统**: 徽章获取、徽章展示
4. **内容审核**: 敏感词过滤、人工审核
5. **数据分析**: 活跃度统计、内容统计

#### 第三阶段（扩展功能）
1. **插件机制**: 第三方功能扩展
2. **API接口**: 开放API供其他系统集成
3. **CDN加速**: 静态资源CDN
4. **缓存优化**: Redis缓存策略

### 4.2 不包含的功能

1. **前端界面**: 仅提供后端API，不包含前端页面
2. **第三方登录**: 暂不集成微信、QQ等第三方登录
3. **实时通讯**: 暂不实现WebSocket实时聊天
4. **支付功能**: 暂不实现积分充值等支付功能
5. **移动端**: 暂不提供移动端专用API

### 4.3 技术约束

1. **技术栈**: 必须使用现有技术栈（NestJS + Prisma + PostgreSQL）
2. **数据库**: 使用现有PostgreSQL数据库，创建独立的表结构
3. **用户体系**: 复用现有ClientUser表，扩展论坛相关字段
4. **缓存**: 使用现有Redis缓存，独立的缓存键前缀
5. **认证**: 使用现有JWT认证体系，独立的token策略
6. **文件上传**: 复用现有上传模块

## 5. 疑问澄清

### 5.1 用户体系问题

**问题**: 论坛用户是否需要独立的用户表，还是复用现有的ClientUser表？

**分析**:
- 方案1: 复用ClientUser表，扩展论坛相关字段
  - 优点: 统一用户管理，数据一致性好
  - 缺点: 论坛和漫画用户耦合，可能互相影响
- 方案2: 创建独立的ForumUser表
  - 优点: 完全隔离，互不影响
  - 缺点: 需要同步用户数据，增加复杂度

**建议**: 复用ClientUser表，通过用户角色区分论坛用户和漫画用户

### 5.2 权限隔离问题

**问题**: 论坛权限系统如何与现有权限系统隔离？

**分析**:
- 现有系统使用JWT认证，基于用户角色进行权限控制
- 论坛需要独立的权限体系（普通用户、版主、管理员）

**建议**: 
1. 在ClientUser表中添加论坛角色字段
2. 创建独立的权限装饰器和守卫
3. 使用不同的JWT token策略区分论坛和漫画

### 5.3 数据库表前缀问题

**问题**: 论坛相关表是否需要统一的前缀？

**分析**:
- 漫画模块使用 `work_` 前缀（如 `work_comic`）
- 论坛模块建议使用 `forum_` 前缀（如 `forum_post`）

**建议**: 使用 `forum_` 前缀，便于区分和管理

### 5.4 路由前缀问题

**问题**: 论坛模块的路由前缀如何设计？

**分析**:
- 漫画模块使用 `/admin/work/comic` 和 `/client/work/comic`
- 论坛模块建议使用 `/admin/forum` 和 `/client/forum`

**建议**: 
- 管理后台: `/admin/forum/{子模块}/{操作}`
- 客户端: `/client/forum/{子模块}/{操作}`

### 5.5 搜索功能问题

**问题**: 论坛搜索功能是否需要独立的搜索引擎？

**分析**:
- 现有系统可能使用数据库模糊搜索
- 论坛搜索需求更复杂（全文搜索、高级搜索、热门搜索）

**建议**: 
1. 第一阶段使用PostgreSQL全文搜索
2. 第二阶段考虑集成Elasticsearch

### 5.6 通知系统问题

**问题**: 论坛通知系统如何与现有通知系统集成？

**分析**:
- 现有系统可能有通知功能
- 论坛通知需要独立的通知类型和模板

**建议**: 
1. 创建独立的通知表（forum_notification）
2. 复用现有通知发送机制
3. 区分通知类型（论坛通知、漫画通知）

### 5.7 内容审核问题

**问题**: 内容审核机制如何实现？

**分析**:
- 需要敏感词过滤
- 需要人工审核功能
- 可能需要AI辅助审核

**建议**: 
1. 第一阶段实现敏感词过滤（基于正则表达式）
2. 第二阶段实现人工审核工作流
3. 第三阶段集成AI审核服务

### 5.8 积分系统问题

**问题**: 积分系统是否需要独立设计？

**分析**:
- 积分系统是社区激励的核心
- 需要支持多种积分获取和消费场景
- 需要积分记录和统计

**建议**: 创建独立的积分系统，包含：
- 积分表（forum_point）
- 积分记录表（forum_point_log）
- 积分规则配置

### 5.9 等级和徽章问题

**问题**: 等级和徽章系统如何设计？

**分析**:
- 等级基于积分和活跃度
- 徽章基于特定成就

**建议**: 
1. 等级系统：基于积分自动升级
2. 徽章系统：基于事件触发（如首次发帖、获得100个赞等）

### 5.10 缓存策略问题

**问题**: 论坛缓存策略如何设计？

**分析**:
- 论坛内容更新频繁
- 需要合理的缓存失效策略
- 需要与漫画模块缓存隔离

**建议**: 
1. 使用独立的缓存键前缀（如 `forum:`）
2. 热门内容长期缓存
3. 用户内容短期缓存
4. 内容更新时主动失效缓存

## 6. 决策点

### 6.1 需要用户确认的关键决策

1. **用户体系**: 是否复用ClientUser表？
2. **权限系统**: 是否需要独立的权限装饰器和守卫？
3. **搜索功能**: 第一阶段使用PostgreSQL全文搜索，还是直接集成Elasticsearch？
4. **内容审核**: 是否需要集成AI审核服务？
5. **积分系统**: 是否需要积分兑换功能？
6. **通知方式**: 是否需要邮件通知和推送通知？
7. **插件机制**: 第一阶段是否需要实现插件机制？
8. **API开放**: 是否需要提供开放API？

### 6.2 暂定决策（待确认）

基于现有项目架构和社区最佳实践，暂定以下决策：

1. **用户体系**: 复用ClientUser表，添加论坛角色字段
2. **权限系统**: 创建独立的权限装饰器和守卫
3. **搜索功能**: 第一阶段使用PostgreSQL全文搜索
4. **内容审核**: 第一阶段实现敏感词过滤
5. **积分系统**: 第一阶段实现基础积分功能
6. **通知方式**: 第一阶段实现站内通知
7. **插件机制**: 第一阶段不实现插件机制
8. **API开放**: 第一阶段不提供开放API

## 7. 下一步行动

1. **等待用户确认**: 确认上述决策点
2. **创建CONSENSUS文档**: 基于确认的需求生成共识文档
3. **设计系统架构**: 设计论坛系统的整体架构
4. **制定功能清单**: 制定详细的功能清单供用户审核
