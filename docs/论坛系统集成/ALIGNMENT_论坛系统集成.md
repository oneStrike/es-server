# 论坛系统集成 - 需求对齐文档

## 1. 项目上下文分析

### 1.1 现有项目结构

**项目名称**: @akaiito/server-nestjs  
**项目类型**: NestJS Monorepo 架构  
**技术栈**:
- 后端框架: NestJS 11.x
- 数据库 ORM: Prisma 7.2.0
- 数据库: PostgreSQL
- 缓存: Redis (使用 Keyv 适配器)
- 认证: JWT + Passport
- API 文档: Swagger
- 包管理: pnpm
- 构建工具: Webpack + SWC

**项目架构**:
```
apps/
├── admin-api/          # 管理后台 API
│   └── src/
│       └── modules/
│           ├── content-management/  # 内容管理模块
│           │   ├── comic/          # 漫画模块
│           │   ├── author/         # 作者模块
│           │   ├── category/       # 分类模块
│           │   └── tag/            # 标签模块
│           ├── auth/               # 认证模块
│           ├── user/               # 用户管理
│           └── system/             # 系统管理
│
└── client-api/          # 客户端 API
    └── src/
        └── modules/
            ├── config/             # 配置管理
            └── dictionary/         # 数据字典

libs/
├── base/               # 基础库（数据库、认证、缓存等）
├── client-config/      # 客户端配置库
├── dictionary/         # 数据字典库
└── member/             # 会员库

prisma/
├── models/             # 数据模型定义
│   ├── admin/          # 管理端模型
│   ├── client/         # 客户端模型
│   └── work/           # 内容工作模型（漫画、作者等）
└── migrations/         # 数据库迁移
```

### 1.2 现有代码模式分析

**模块组织模式**:
- 每个业务模块独立为一个目录
- 模块内部结构: `controller.ts`, `service.ts`, `module.ts`, `dto/`
- 使用 NestJS 的模块化架构，通过 `@Module` 装饰器组织
- 通过 `libs/` 目录共享通用功能

**数据库设计模式**:
- 使用 Prisma ORM 进行数据库操作
- 模型定义在 `prisma/models/` 目录下，按功能域分类
- 使用软删除机制 (`deletedAt` 字段)
- 支持多对多关系（通过中间表）
- 使用索引优化查询性能

**API 设计模式**:
- RESTful API 设计
- 统一响应格式（通过 `TransformInterceptor`）
- 使用 Swagger 生成 API 文档
- DTO 进行数据验证（使用 class-validator）
- 统一异常处理（`HttpExceptionFilter`）

**认证授权模式**:
- JWT 认证机制
- 全局 JWT Guard (`JwtAuthGuard`)
- 基于角色的权限控制
- 审计日志拦截器 (`AuditInterceptor`)

**路由前缀规范**:
- 管理端: `/admin/work/*` (内容管理), `/admin/system/*` (系统管理)
- 客户端: `/api/*`

### 1.3 现有数据模型

**漫画相关模型**:
- `WorkComic`: 漫画主表
- `WorkComicChapter`: 漫画章节
- `WorkComicAuthor`: 漫画-作者关联
- `WorkComicCategory`: 漫画-分类关联
- `WorkComicTag`: 漫画-标签关联
- `WorkAuthor`: 作者表
- `WorkCategory`: 分类表
- `WorkTag`: 标签表

**用户相关模型**:
- `AdminUser`: 管理员用户
- `ClientUser`: 客户端用户
- `MemberLevel`: 会员等级

**系统相关模型**:
- `ClientConfig`: 客户端配置
- `ClientNotice`: 客户端通知
- `ClientPage`: 客户端页面
- `Dictionary`: 数据字典
- `RequestLog`: 请求日志

### 1.4 业务域理解

当前项目是一个漫画内容管理系统，主要功能包括:
- 漫画内容管理（创建、编辑、发布、删除）
- 作者管理
- 分类和标签管理
- 章节管理
- 用户和会员管理
- 内容审核
- 数据统计（浏览量、点赞、收藏等）

## 2. 原始需求

用户需要为当前项目接入论坛系统（参考 zibll.com 的论坛功能），要求:

### 2.1 架构隔离改造
- 设计独立的论坛模块目录结构，与漫画模块在代码层面完全分离
- 实现独立的数据库表结构
- 配置独立的路由前缀，避免与漫画模块路由冲突
- 开发独立的权限控制系统，确保论坛用户权限与漫画模块权限体系隔离

### 2.2 功能集成改造
- 开发论坛内容展示、发布、评论、点赞等核心功能
- 集成搜索功能，确保论坛内容搜索与漫画内容搜索相互独立
- 实现通知系统，区分论坛相关通知与漫画模块通知

### 2.3 社区最佳实践实施
- 建立清晰的社区规则与版主管理制度
- 实现内容审核机制，包括人工审核与AI辅助审核
- 开发用户行为激励系统，如积分、等级、徽章体系
- 设计合理的内容组织形式，如板块分类、标签体系
- 集成数据分析功能，跟踪社区活跃度、用户行为等关键指标

### 2.4 性能与安全优化
- 实现论坛内容缓存策略，与漫画模块缓存机制分离
- 配置独立的CDN资源，避免影响漫画模块加载速度
- 加强论坛模块安全防护，防止XSS、CSRF等常见攻击
- 实现防刷屏、反垃圾信息机制，维护社区环境健康

### 2.5 可扩展性设计
- 采用模块化架构，便于未来功能扩展
- 设计插件机制，支持第三方功能扩展
- 预留API接口，便于未来与其他系统集成

### 2.6 实施要求
- 论坛模块的开发、测试、部署流程与漫画模块相互独立，避免相互影响

## 3. 边界确认

### 3.1 任务范围（包含）
1. 论坛模块的完整设计和实现
2. 论坛数据库表结构设计和迁移
3. 论坛核心功能开发（帖子、回复、点赞、评论）
4. 论坛权限系统（独立于漫画模块）
5. 论坛搜索功能（独立索引）
6. 论坛通知系统
7. 论坛缓存策略
8. 论坛安全防护（XSS、CSRF、防刷屏）
9. 社区管理功能（版主、审核、举报）
10. 用户激励系统（积分、等级、徽章）
11. 论坛数据分析
12. API 文档

### 3.2 任务范围（不包含）
1. 前端界面开发（仅提供后端 API）
2. 论坛与漫画模块的数据互通（如漫画讨论帖等）
3. 第三方论坛系统集成（如 Discuz、phpBB 等）
4. 实时聊天功能
5. 论坛插件市场开发
6. 论坛移动端适配（后端 API 应支持，但前端不在范围内）

### 3.3 技术边界
- 使用项目现有的技术栈（NestJS、Prisma、PostgreSQL、Redis）
- 不引入新的数据库或缓存系统
- 不引入新的认证系统（复用现有 JWT）
- 不修改现有漫画模块代码
- 不影响现有漫画模块功能

## 4. 需求理解

### 4.1 论坛模块定位
论坛模块是一个独立的内容社区系统，与漫画模块并列存在，两者在数据、权限、缓存等方面完全隔离。

### 4.2 架构隔离策略
1. **代码隔离**: 论坛模块代码放在独立的目录 `apps/admin-api/src/modules/forum/` 和 `apps/client-api/src/modules/forum/`
2. **数据库隔离**: 论坛相关的数据表使用 `forum_` 前缀，与漫画模块的 `work_` 前缀区分
3. **路由隔离**: 论坛模块使用 `/admin/forum/*` 和 `/api/forum/*` 路由前缀
4. **权限隔离**: 论坛使用独立的权限体系，与漫画模块权限互不影响
5. **缓存隔离**: 论坛缓存使用独立的命名空间（如 `Forum:`）

### 4.3 功能模块划分
基于需求，论坛模块应包含以下子模块:

**管理端模块** (`apps/admin-api/src/modules/forum/`):
1. `board/` - 版块管理
2. `topic/` - 主题/帖子管理
3. `reply/` - 回复管理
4. `comment/` - 评论管理
5. `moderator/` - 版主管理
6. `audit/` - 内容审核
7. `report/` - 举报管理
8. `user/` - 论坛用户管理
9. `point/` - 积分管理
10. `badge/` - 徽章管理
11. `level/` - 等级管理
12. `analytics/` - 数据分析

**客户端模块** (`apps/client-api/src/modules/forum/`):
1. `board/` - 版块浏览
2. `topic/` - 主题浏览和发布
3. `reply/` - 回复功能
4. `comment/` - 评论功能
5. `like/` - 点赞功能
6. `search/` - 搜索功能
7. `notification/` - 通知功能
8. `user/` - 用户中心
9. `point/` - 积分查询
10. `badge/` - 徽章展示

**共享库** (`libs/forum/`):
1. 数据模型定义
2. 共享服务
3. 共享 DTO
4. 共享工具函数

### 4.4 数据模型设计思路
论坛模块需要以下核心数据模型:

**用户相关**:
- `ForumUser`: 论坛用户信息（扩展 ClientUser）
- `ForumUserProfile`: 用户档案
- `ForumUserLevel`: 用户等级
- `ForumUserBadge`: 用户徽章
- `ForumUserPoint`: 用户积分记录

**内容相关**:
- `ForumBoard`: 版块
- `ForumTopic`: 主题/帖子
- `ForumReply`: 回复
- `ForumComment`: 评论
- `ForumLike`: 点赞记录

**管理相关**:
- `ForumModerator`: 版主
- `ForumAudit`: 审核记录
- `ForumReport`: 举报记录
- `ForumRule`: 社区规则

**系统相关**:
- `ForumTag`: 标签
- `ForumTopicTag`: 主题标签关联
- `ForumAttachment`: 附件
- `ForumNotification`: 通知
- `ForumAnalytics`: 数据统计

### 4.5 权限系统设计
论坛权限系统应独立于漫画模块，但可以复用现有的 JWT 认证机制:

**权限层级**:
1. **普通用户**: 浏览、发帖、回复、点赞
2. **版主**: 管理指定版块的内容（置顶、加精、删除、封禁）
3. **超级版主**: 管理所有版块
4. **管理员**: 系统级管理权限

**权限控制点**:
- API 级别: 通过 Guard 控制访问
- 数据级别: 通过 Service 层逻辑控制
- 操作级别: 通过装饰器和中间件控制

### 4.6 缓存策略设计
论坛缓存应与漫画模块隔离:

**缓存命名空间**:
- 论坛缓存前缀: `Forum:`
- 版块缓存: `Forum:Board:{id}`
- 主题缓存: `Forum:Topic:{id}`
- 用户缓存: `Forum:User:{id}`
- 热门内容: `Forum:Hot:*`
- 搜索结果: `Forum:Search:{hash}`

**缓存策略**:
- 版块列表: 长期缓存（1小时）
- 热门主题: 中期缓存（10分钟）
- 用户信息: 中期缓存（5分钟）
- 搜索结果: 短期缓存（1分钟）
- 统计数据: 定期刷新（15分钟）

### 4.7 安全防护设计
1. **XSS 防护**: 输入过滤、输出转义、CSP 策略
2. **CSRF 防护**: CSRF Token 验证
3. **防刷屏**: 限流策略（基于 IP 和用户）
4. **反垃圾**: 内容过滤、敏感词检测、AI 辅助审核
5. **SQL 注入**: 使用 Prisma ORM 自动防护
6. **权限验证**: 严格的权限检查

### 4.8 搜索功能设计
论坛搜索应独立于漫画搜索:

**搜索范围**:
- 主题标题和内容
- 回复内容
- 用户昵称
- 标签

**搜索方式**:
- 关键词搜索
- 标签筛选
- 版块筛选
- 时间范围筛选
- 用户筛选

**搜索优化**:
- 使用 PostgreSQL 全文搜索
- 建立搜索索引
- 缓存热门搜索结果
- 搜索历史记录

## 5. 疑问澄清

### 5.1 需要用户确认的问题

**高优先级问题**:

1. **论坛用户体系**:
   - 论坛用户是否复用现有的 `ClientUser`，还是需要独立的 `ForumUser`？
   - 如果复用，是否需要在 `ClientUser` 中增加论坛相关字段？
   - 论坛用户等级、积分、徽章等数据如何存储？

2. **权限系统集成**:
   - 论坛权限系统是否需要与现有的 AdminUser 权限系统集成？
   - 管理员是否可以同时管理漫画和论坛？
   - 版主权限是否需要存储在数据库中，还是硬编码？

3. **通知系统**:
   - 论坛通知是否需要与现有的 `ClientNotice` 系统集成？
   - 通知类型如何区分（论坛通知 vs 漫画通知）？
   - 是否需要实时通知（WebSocket）？

4. **搜索功能**:
   - 论坛搜索是否需要使用专门的搜索引擎（如 Elasticsearch）？
   - 还是可以使用 PostgreSQL 全文搜索？
   - 搜索结果是否需要与漫画搜索结果合并展示？

5. **内容审核**:
   - AI 辅助审核是否需要接入第三方服务（如阿里云内容安全）？
   - 审核规则如何配置？
   - 审核失败的内容如何处理？

6. **数据分析**:
   - 数据分析指标具体包括哪些？
   - 是否需要数据可视化界面？
   - 数据分析结果是否需要导出？

**中优先级问题**:

7. **附件功能**:
   - 论坛是否支持上传图片、视频等附件？
   - 附件存储方式（本地存储、OSS、CDN）？
   - 附件大小和格式限制？

8. **标签系统**:
   - 论坛标签是否与漫画标签系统共用？
   - 标签是否需要层级结构？
   - 标签是否需要管理员审核？

9. **积分系统**:
   - 积分规则如何配置（发帖、回复、点赞等行为对应多少积分）？
   - 积分是否可以兑换或消费？
   - 积分排行榜是否需要？

10. **等级系统**:
    - 等级晋升规则如何配置（基于积分、发帖数等）？
    - 等级是否需要对应的权限？
    - 等级徽章如何展示？

**低优先级问题**:

11. **插件机制**:
    - 插件机制的具体需求是什么？
    - 插件是否需要热加载？
    - 插件市场是否需要？

12. **API 接口**:
    - 是否需要开放 API 给第三方调用？
    - API 认证方式（OAuth、API Key）？
    - API 限流策略？

13. **国际化**:
    - 论坛是否需要支持多语言？
    - 现有项目是否已支持国际化？

14. **移动端适配**:
    - API 是否需要针对移动端优化（如分页大小、返回字段）？
    - 是否需要移动端专用的 API？

### 5.2 技术决策点

基于现有项目架构，以下技术决策已明确:

1. **数据库**: 使用 PostgreSQL（与现有项目一致）
2. **ORM**: 使用 Prisma（与现有项目一致）
3. **缓存**: 使用 Redis（与现有项目一致）
4. **认证**: 使用 JWT（复用现有机制）
5. **API 风格**: RESTful API（与现有项目一致）
6. **文档**: 使用 Swagger（与现有项目一致）
7. **验证**: 使用 class-validator（与现有项目一致）

### 5.3 风险评估

**技术风险**:
1. 论坛模块可能影响现有系统性能（需要通过缓存和优化降低影响）
2. 数据库表数量增加可能影响查询性能（需要合理设计索引）
3. 搜索功能可能需要额外的优化（需要测试和调整）

**业务风险**:
1. 论坛用户体系与现有用户体系的集成可能存在兼容性问题
2. 权限系统的隔离可能增加管理复杂度
3. 论坛内容审核可能需要大量人力投入

**实施风险**:
1. 开发工作量较大，需要合理规划时间
2. 测试覆盖需要充分，确保不影响现有功能
3. 部署和迁移需要谨慎，避免数据丢失

## 6. 智能决策

基于现有项目架构和社区最佳实践，对部分疑问进行智能决策:

### 6.1 论坛用户体系
**决策**: 论坛用户复用现有的 `ClientUser`，通过扩展表存储论坛特定数据

**理由**:
- 避免用户数据冗余
- 简化用户登录和认证流程
- 便于统一管理用户信息

**实现方案**:
- `ClientUser` 作为基础用户表
- 创建 `ForumUserProfile` 扩展表，存储论坛相关字段（如等级、积分、徽章等）
- 通过 `userId` 关联

### 6.2 权限系统
**决策**: 论坛权限系统独立于漫画模块，但管理员可以同时管理两者

**理由**:
- 保持模块独立性
- 降低权限系统的复杂度
- 便于未来扩展

**实现方案**:
- 创建 `ForumRole` 表定义论坛角色（普通用户、版主、超级版主、管理员）
- 创建 `ForumUserRole` 关联表，记录用户的论坛角色
- 通过 Guard 实现权限验证
- 管理员通过 `AdminUser` 的权限管理论坛

### 6.3 通知系统
**决策**: 论坛通知独立于漫画通知，但可以复用现有的通知基础设施

**理由**:
- 保持模块独立性
- 便于区分不同类型的通知
- 复用现有基础设施降低开发成本

**实现方案**:
- 创建 `ForumNotification` 表
- 通知类型通过 `type` 字段区分（如 `TOPIC_REPLY`, `TOPIC_LIKE` 等）
- 复用现有的通知服务逻辑

### 6.4 搜索功能
**决策**: 使用 PostgreSQL 全文搜索，不引入专门的搜索引擎

**理由**:
- PostgreSQL 全文搜索功能足够强大
- 避免引入额外的技术栈
- 降低系统复杂度和维护成本

**实现方案**:
- 使用 PostgreSQL 的 `tsvector` 和 `to_tsquery` 函数
- 为搜索字段创建 GIN 索引
- 实现搜索结果缓存

### 6.5 内容审核
**决策**: 先实现人工审核功能，AI 辅助审核作为可扩展功能

**理由**:
- 人工审核更可控，适合初期
- AI 审核需要额外的成本和配置
- 可以通过插件机制扩展 AI 审核功能

**实现方案**:
- 创建 `ForumAudit` 表记录审核历史
- 实现审核状态机（待审核、已通过、已拒绝）
- 预留 AI 审核接口

### 6.6 数据分析
**决策**: 实现基础的数据统计功能，不提供可视化界面

**理由**:
- 后端 API 提供数据，前端可以自行实现可视化
- 降低后端开发复杂度
- 便于灵活定制数据分析需求

**实现方案**:
- 创建 `ForumAnalytics` 表存储统计数据
- 定时任务更新统计数据
- 提供 API 查询统计数据

### 6.7 附件功能
**决策**: 支持图片上传，使用现有的上传服务

**理由**:
- 复用现有的上传基础设施
- 降低开发成本
- 保持一致性

**实现方案**:
- 创建 `ForumAttachment` 表
- 复用 `libs/upload` 上传服务
- 限制附件大小和格式

### 6.8 标签系统
**决策**: 论坛标签独立于漫画标签，不共用

**理由**:
- 保持模块独立性
- 避免标签冲突
- 便于独立管理

**实现方案**:
- 创建 `ForumTag` 表
- 创建 `ForumTopicTag` 关联表
- 实现标签的增删改查功能

### 6.9 积分系统
**决策**: 实现基础的积分系统，积分规则可配置

**理由**:
- 激励用户参与
- 积分规则可配置便于运营调整
- 暂不支持积分兑换

**实现方案**:
- 创建 `ForumUserPoint` 表记录积分变化
- 创建 `ForumPointRule` 表配置积分规则
- 实现积分增加和减少的原子操作

### 6.10 等级系统
**决策**: 基于积分的等级系统，等级规则可配置

**理由**:
- 等级是用户激励的重要手段
- 基于积分的等级系统简单直观
- 等级规则可配置便于调整

**实现方案**:
- 创建 `ForumUserLevel` 表定义等级
- 根据积分自动计算用户等级
- 实现等级徽章展示

### 6.11 插件机制
**决策**: 暂不实现插件机制，通过模块化设计支持扩展

**理由**:
- 插件机制复杂度高，开发成本大
- 模块化设计已经具备一定的扩展性
- 可以在后续版本中根据需求添加

**实现方案**:
- 采用模块化架构
- 提供清晰的接口和扩展点
- 预留钩子函数

### 6.12 API 接口
**决策**: 暂不开放第三方 API，仅提供内部 API

**理由**:
- 初期不需要第三方集成
- 降低安全风险
- 可以在后续版本中根据需求添加

**实现方案**:
- API 仅限内部使用
- 通过 JWT 认证
- 预留 API 扩展接口

### 6.13 国际化
**决策**: 暂不支持多语言

**理由**:
- 初期仅支持中文
- 降低开发复杂度
- 可以在后续版本中添加

**实现方案**:
- 所有文本内容使用中文
- 预留国际化接口

### 6.14 移动端适配
**决策**: API 设计考虑移动端需求，但不提供移动端专用 API

**理由**:
- 统一 API 降低维护成本
- 通过响应式设计适配不同设备
- 可以根据实际需求优化

**实现方案**:
- API 返回数据精简，减少传输量
- 支持分页查询
- 预留移动端专用字段

## 7. 下一步行动

1. 等待用户确认上述智能决策
2. 根据用户反馈调整需求理解
3. 创建 CONSENSUS 文档，明确最终共识
4. 创建 DESIGN 文档，设计系统架构
5. 创建 TASK 文档，拆分原子任务
6. 开始实施论坛模块开发

---

**文档版本**: v1.0  
**创建时间**: 2026-01-03  
**最后更新**: 2026-01-03  
**状态**: 待用户确认
