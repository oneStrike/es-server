# 论坛经验系统优化 - 待办事项清单

## 数据库相关

### 1. 数据库迁移
- [ ] 运行 Prisma 迁移命令创建新的数据库表
  ```bash
  npx prisma migrate dev --name add_experience_system
  ```

### 2. 数据初始化
- [ ] 为现有用户初始化 experience 字段
  - 需要根据用户的现有积分或等级计算初始经验值
  - 建议创建一个数据迁移脚本
  
- [ ] 配置初始经验规则数据
  - 发表主题：+5 经验，每日上限 10 次
  - 发表回复：+2 经验，每日上限 20 次
  - 主题被点赞：+1 经验，每日上限 50 次
  - 回复被点赞：+1 经验，每日上限 50 次
  - 主题被收藏：+2 经验，每日上限 20 次
  - 每日签到：+3 经验，每日上限 1 次
  
- [ ] 更新现有等级规则的 requiredExperience 字段
  - 需要根据新的经验值体系重新设计等级规则
  - 建议参考现有积分体系进行转换

## 模块注册和配置

### 3. 模块导入
- [ ] 在 `ForumModule` 中导入 `ExperienceModule`
  - 文件位置：`libs/forum/src/forum.module.ts`
  - 添加导入：`import { ExperienceModule } from './experience/experience.module'`
  - 在 imports 数组中添加：`ExperienceModule`

### 4. 服务注入
- [ ] 在需要使用 ExperienceService 的模块中注入服务
  - 例如：TopicModule、ReplyModule 等
  - 确保正确导入 ExperienceModule

## 测试相关

### 5. 单元测试
- [ ] 编写 ExperienceService 单元测试
  - 测试增加经验功能
  - 测试减少经验功能
  - 测试每日上限检查
  - 测试经验记录查询
  - 测试经验统计功能
  - 测试经验规则管理功能

- [ ] 编写 LevelRuleService 单元测试
  - 测试基于经验的等级计算
  - 测试等级进度计算
  - 测试等级更新功能

### 6. 集成测试
- [ ] 编写经验系统集成测试
  - 测试完整的经验获取流程
  - 测试经验与等级的联动
  - 测试事务回滚场景

### 7. 边界条件测试
- [ ] 测试用户不存在的情况
- [ ] 测试规则不存在的情况
- [ ] 测试每日上限达到的情况
- [ ] 测试经验值为负数的情况
- [ ] 测试并发操作的情况

## 文档相关

### 8. API 文档
- [ ] 更新 Swagger/OpenAPI 文档
  - 添加 ExperienceService 的 API 文档
  - 更新 LevelRuleService 的 API 文档

### 9. 使用说明
- [ ] 编写经验系统使用说明
  - 如何配置经验规则
  - 如何调用经验服务
  - 如何查询经验记录

### 10. 数据库设计文档
- [ ] 更新数据库设计文档
  - 添加新的表结构说明
  - 更新字段说明
  - 添加索引说明

## 业务集成相关

### 11. 发表主题集成
- [ ] 在发表主题时调用增加经验
  - 文件位置：`libs/forum/src/topic/forum-topic.service.ts`
  - 在创建主题成功后调用 `experienceService.addExperience()`
  - 使用 `ExperienceRuleTypeEnum.CREATE_TOPIC` 类型

### 12. 发表回复集成
- [ ] 在发表回复时调用增加经验
  - 文件位置：`libs/forum/src/reply/forum-reply.service.ts`
  - 在创建回复成功后调用 `experienceService.addExperience()`
  - 使用 `ExperienceRuleTypeEnum.CREATE_REPLY` 类型

### 13. 点赞操作集成
- [ ] 在主题被点赞时调用增加经验
  - 文件位置：`libs/forum/src/like/forum-like.service.ts`
  - 在点赞主题成功后调用 `experienceService.addExperience()`
  - 使用 `ExperienceRuleTypeEnum.TOPIC_LIKED` 类型

- [ ] 在回复被点赞时调用增加经验
  - 文件位置：`libs/forum/src/like/forum-like.service.ts`
  - 在点赞回复成功后调用 `experienceService.addExperience()`
  - 使用 `ExperienceRuleTypeEnum.REPLY_LIKED` 类型

### 14. 收藏操作集成
- [ ] 在主题被收藏时调用增加经验
  - 文件位置：`libs/forum/src/favorite/forum-favorite.service.ts`
  - 在收藏主题成功后调用 `experienceService.addExperience()`
  - 使用 `ExperienceRuleTypeEnum.TOPIC_FAVORITED` 类型

### 15. 签到功能集成
- [ ] 在签到功能中调用增加经验
  - 需要确认签到功能的位置
  - 在签到成功后调用 `experienceService.addExperience()`
  - 使用 `ExperienceRuleTypeEnum.DAILY_CHECK_IN` 类型

### 16. 用户资料显示
- [ ] 在用户资料页面显示经验值
  - 需要确认用户资料页面的位置
  - 添加经验值显示组件
  - 添加经验记录查询功能

### 17. 等级显示
- [ ] 在等级显示中显示经验进度
  - 需要确认等级显示的位置
  - 更新等级显示逻辑，使用 `getUserLevelInfo` 方法
  - 显示当前经验、下一等级所需经验、进度百分比

## 性能优化相关

### 18. 数据库优化
- [ ] 优化经验记录查询性能
  - 考虑添加复合索引
  - 考虑分表策略（如果数据量大）

### 19. 缓存优化
- [ ] 添加经验规则缓存
  - 使用 Redis 缓存经验规则
  - 减少数据库查询

- [ ] 添加用户经验缓存
  - 使用 Redis 缓存用户经验值
  - 定期同步到数据库

## 监控告警相关

### 20. 日志记录
- [ ] 添加经验操作日志
  - 记录所有经验变化操作
  - 便于问题追踪和审计

### 21. 监控指标
- [ ] 添加经验系统监控指标
  - 经验获取总量
  - 经验消耗总量
  - 经验规则使用情况
  - 异常操作监控

### 22. 告警配置
- [ ] 配置异常操作告警
  - 经验异常增长告警
  - 经验异常减少告警
  - 规则配置错误告警

## 安全相关

### 23. 权限控制
- [ ] 添加经验规则管理权限
  - 只有管理员可以管理经验规则
  - 只有管理员可以手动调整用户经验

### 24. 防刷机制
- [ ] 添加经验获取防刷机制
  - 限制同一 IP 的经验获取
  - 限制短时间内的经验获取
  - 添加验证码机制

## 其他

### 25. 数据备份
- [ ] 配置经验数据备份策略
  - 定期备份经验记录
  - 确保数据可恢复

### 26. 数据迁移工具
- [ ] 开发数据迁移工具
  - 用于将现有积分转换为经验
  - 用于数据修复和调整

### 27. 管理后台
- [ ] 开发经验规则管理界面
  - 在管理后台添加经验规则管理功能
  - 支持规则的增删改查

- [ ] 开发用户经验管理界面
  - 在管理后台添加用户经验查询功能
  - 支持手动调整用户经验

## 优先级说明

### 高优先级（必须完成）
- 数据库迁移（1-3）
- 模块注册和配置（3-4）
- 业务集成（11-17）

### 中优先级（建议完成）
- 单元测试（5）
- 集成测试（6）
- API 文档（8）
- 性能优化（18-19）

### 低优先级（可选完成）
- 边界条件测试（7）
- 使用说明（9）
- 数据库设计文档（10）
- 监控告警（20-22）
- 安全相关（23-24）
- 其他（25-27）

## 操作指引

### 快速开始
1. 首先完成数据库迁移（任务1-3）
2. 然后完成模块注册（任务4）
3. 接着完成核心业务集成（任务11-17）
4. 最后完成测试和文档（任务5-10）

### 分阶段实施
- **第一阶段**：数据库迁移和模块注册（任务1-4）
- **第二阶段**：核心业务集成（任务11-17）
- **第三阶段**：测试和文档（任务5-10）
- **第四阶段**：优化和完善（任务18-27）

### 注意事项
1. 数据库迁移前请备份数据库
2. 测试环境验证后再部署到生产环境
3. 经验规则配置需要根据实际业务调整
4. 建议先在测试环境完整测试后再上线
