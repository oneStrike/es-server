章节评论功能_任务清单

任务 01：新增章节评论数据表与关系
- 数据表：work_comic_chapter_comment
- 字段清单：
  - id：主键自增
  - chapter_id：章节 ID，关联 work_comic_chapter.id
  - user_id：用户 ID，关联 app_user.id
  - content：评论内容
  - sensitive_word_hits：命中的敏感词明细（可为空）
  - reply_to_id：被回复的评论 ID（楼中楼，可为空）
  - actual_reply_to_id：追溯链路的根评论 ID（可为空）
  - floor：楼层号（一级评论编号，楼中楼为空）
  - is_hidden：是否隐藏（默认 false）
  - audit_status：审核状态（0=待审核，1=通过，2=拒绝）
  - audit_reason：审核原因（可为空）
  - audit_at：审核时间（可为空）
  - audit_by_id：审核人 ID（可为空）
  - audit_role：审核角色（0=版主，1=管理员，可为空）
  - created_at / updated_at / deleted_at：创建、更新时间、软删时间
- 关联关系：
  - WorkComicChapter.comments
  - AppUser.comicChapterComments
- 索引建议：
  - chapter_id
  - user_id
  - created_at
  - audit_status
  - is_hidden
  - reply_to_id
  - actual_reply_to_id
- 实现约束：采用软删除；删除与审核变更应保持计数一致
- 依赖关系：无
- 验收标准：Prisma 模型与关联关系建立完成，迁移可生成
- 细化说明：
  - 默认值：is_hidden=false，audit_status=0
  - 字段类型：sensitive_word_hits=JSON，可为空
  - 楼中楼约束：reply_to_id 允许为空；actual_reply_to_id 保存根评论 ID
  - 计数基准：仅统计 audit_status=1 且 is_hidden=false 的记录

任务 02：新增章节评论枚举与 DTO
- 新增枚举：ChapterCommentAuditStatusEnum（PENDING/APPROVED/REJECTED）
- DTO 清单：
  - BaseComicChapterCommentDto（content、chapterId、userId、replyToId、floor、isHidden、auditStatus、sensitiveWordHits 等）
  - CreateComicChapterCommentDto（content、chapterId、replyToId）
  - QueryComicChapterCommentDto（chapterId、userId、auditStatus、isHidden、sortBy、sortOrder、分页）
  - UpdateComicChapterCommentAuditDto（id、auditStatus、auditReason）
  - UpdateComicChapterCommentHiddenDto（id、isHidden）
  - DeleteComicChapterCommentDto（id）
  - ComicChapterCommentDto（包含用户信息与被回复对象简要信息）
- 实现约束：字段校验风格与现有 Validate* 装饰器一致
- 依赖关系：任务 01
- 验收标准：DTO 与枚举可被 Swagger 正常展示
- 细化说明：
  - CreateDto：content 长度范围与当前评论策略一致
  - QueryDto：默认分页参数与全站分页策略一致
  - OutputDto：包含 reply_to 轻量信息（被回复人 id/nickname）

任务 03：系统级配置抽离（内容治理）
- 抽离范围：
  - 内容审核策略（敏感词处罚策略）
  - 全站维护模式
  - 站点基础信息
  - 账号注册与验证策略
  - 全局通知策略
- 实现约束：系统级配置与论坛配置解耦，论坛可按需覆盖
- 依赖关系：任务 01-02
- 验收标准：系统级配置可独立读取，论坛与漫画评论可复用
- 细化说明：
  - 配置来源：system-config 或独立系统配置表
  - 管理接口：查询/更新系统配置，支持缓存失效
  - 兼容策略：论坛优先读取论坛覆盖项，否则回退系统配置
- 子任务清单：
  - 任务 03-1：系统级配置表结构设计
    - 新表：system_config 或 system_content_policy
    - 字段建议（字段级）：
      - id：主键自增
      - updated_by_id：最后修改人 ID
      - content_review_policy：敏感词处罚策略（JSON）
        - severe_action：严重级别处理（通过/待审/拒绝/隐藏）
        - general_action：一般级别处理（通过/待审/拒绝/隐藏）
        - light_action：轻微级别处理（通过/待审/拒绝/隐藏）
        - record_hits：是否记录命中明细（boolean）
      - maintenance_enabled：维护模式开关（boolean）
      - maintenance_message：维护提示文案（string）
      - site_name：站点名称（string）
      - site_description：站点描述（string）
      - site_keywords：站点关键词（string）
      - site_logo：站点 Logo（string）
      - site_favicon：站点图标（string）
      - contact_email：联系邮箱（string）
      - icp_number：备案号（string）
      - register_enable：是否允许注册（boolean）
      - register_email_verify：注册邮箱验证（boolean）
      - register_phone_verify：注册手机验证（boolean）
      - notify_email：邮件通知总开关（boolean）
      - notify_in_app：站内通知总开关（boolean）
      - notify_system：系统通知总开关（boolean）
      - created_at / updated_at：创建、更新时间
    - 约束：字段命名风格与现有 forum_config 对齐
    - 验收标准：Prisma 模型与迁移可生成
  - 任务 03-2：系统级配置 DTO 与枚举
    - DTO：QuerySystemConfigDto、UpdateSystemConfigDto、SystemConfigDto
    - 枚举：ContentReviewPolicyEnum 或使用 JSON schema 约束
    - 验收标准：Swagger 可展示，字段校验完整
  - 任务 03-3：系统级配置服务层
    - 服务：SystemConfigService
    - 能力：获取配置、更新配置、创建默认配置
    - 约束：缺省配置自动补全
    - 验收标准：无配置时返回默认值
  - 任务 03-4：系统级配置缓存策略
    - 缓存：system_config 缓存键与 TTL
    - 失效：更新配置后主动失效
    - 预热：应用启动预加载
    - 验收标准：高并发读取不穿透
  - 任务 03-5：系统级配置管理接口
    - 管理端：GET/POST /admin/system/config
    - 权限：管理员可更新
    - 验收标准：配置更新后缓存即时生效
  - 任务 03-6：论坛与漫画评论接入系统配置
    - 论坛：优先使用论坛覆盖配置，未配置时回退系统配置
    - 漫画评论：直接读取系统配置
    - 验收标准：两业务读取路径一致、规则生效

任务 04：评论创建与权限校验
- 输入契约：CreateComicChapterCommentDto + userId（登录态）
- 校验规则：
  - 章节存在且未删除
  - 章节 canComment 为 true
  - 章节已发布或为试读章节时可评论（与现有业务策略一致）
  - reply_to_id 存在且归属同一章节
  - reply_to_id 不能为楼中楼的子回复（仅允许一层楼中楼）
  - 用户状态校验（禁言/封禁不可评论）
- 敏感词检测：
  - 使用公共敏感词模块 SensitiveWordDetectService
  - 命中敏感词时记录 hits，审核/处罚由系统配置决定
- 输出契约：返回创建后的评论记录
- 实现约束：创建评论与 commentCount 计数更新在同一事务内
- 依赖关系：任务 01-03
- 验收标准：禁止评论章节返回明确异常；回复跨章节被拒绝
- 细化说明：
  - 楼中楼：reply_to_id 指向一级评论时，actual_reply_to_id=reply_to_id
  - 敏感词：记录 hits，按系统配置决定 audit_status 与 is_hidden
  - 返回结果：包含楼层号、审核状态、隐藏状态、命中明细

任务 05：评论列表与分页
- 输入契约：QueryComicChapterCommentDto
- 输出契约：分页列表（一级评论 + 一层楼中楼）
- 实现约束：
  - 默认仅返回审核通过且未隐藏的评论
  - 支持按 createdAt/floor 排序
  - 返回用户基础信息（昵称、头像）
- 依赖关系：任务 02
- 验收标准：分页接口返回结构稳定，列表按规则排序
- 细化说明：
  - 一级评论分页，楼中楼作为 children 返回
  - 管理端可通过参数查看未审核/隐藏评论
  - 查询条件支持 userId/时间区间

任务 06：评论删除（用户侧）
- 输入契约：DeleteComicChapterCommentDto + userId
- 输出契约：删除成功标记
- 实现约束：
  - 仅允许删除自己评论
  - 软删除并同步更新章节 commentCount
  - 被删除评论仅删除当前评论，不处理其楼中楼
- 依赖关系：任务 01-04
- 验收标准：删除后列表不可见，commentCount 变化正确
- 细化说明：
  - 删除前校验：评论归属与章节一致
  - 删除后策略：楼中楼仍可展示但提示“原评论已删除”

任务 07：评论审核与隐藏（管理端）
- 输入契约：UpdateComicChapterCommentAuditDto / UpdateComicChapterCommentHiddenDto
- 输出契约：审核或隐藏结果
- 实现约束：
  - 审核通过时计入 commentCount
  - 审核拒绝或隐藏时从 commentCount 扣减
  - 记录 audit_at、audit_by_id、audit_role
  - 敏感词命中记录与审核状态保持一致
- 依赖关系：任务 01-03
- 验收标准：审核状态变更与计数一致
- 细化说明：
  - 审核通过时写入 audit_at/audit_by_id/audit_role
  - 审核拒绝时记录 audit_reason
  - 隐藏为独立开关，不改变审核状态

任务 08：章节评论计数一致性
- 输入契约：评论创建/删除/审核/隐藏
- 输出契约：章节 commentCount 与评论状态一致
- 实现约束：统一封装计数更新方法，避免重复逻辑
- 依赖关系：任务 04-07
- 验收标准：并发创建/删除后 commentCount 不出现负数或错账
- 细化说明：
  - 仅统计可见评论
  - 事务内更新计数，避免跨服务重复逻辑

任务 09：应用端接口接入
- 接口清单（app-api）：
  - POST /comic/chapter/comment/create
  - GET /comic/chapter/comment/page
  - POST /comic/chapter/comment/delete
- 输出契约：返回 ComicChapterCommentDto 或分页结果
- 实现约束：复用现有 CurrentUser 与 ApiDoc 装饰器风格
- 依赖关系：任务 02、04-06
- 验收标准：接口可用且文档可见
- 细化说明：
  - create 接口返回审核状态与是否隐藏
  - page 接口按一级评论分页，附带楼中楼

任务 10：管理端接口接入
- 接口清单（admin-api）：
  - GET /admin/work/comic-chapter-comment/page
  - GET /admin/work/comic-chapter-comment/detail
  - POST /admin/work/comic-chapter-comment/audit
  - POST /admin/work/comic-chapter-comment/hide
  - POST /admin/work/comic-chapter-comment/delete
  - POST /admin/work/comic-chapter-comment/report
- 实现约束：保持与现有内容管理接口命名一致
- 依赖关系：任务 02、07
- 验收标准：管理端可分页、审核、隐藏与删除评论
- 细化说明：
  - page 支持筛选 audit_status/is_hidden/user_id/keyword
  - report 支持处理状态与备注

任务 11：模块与索引导出
- 变更清单：
  - libs/content/src/comic/chapter-comment（module/service/dto/index）
  - apps/app-api/src/modules/comic/comic.module.ts（导入评论模块）
  - apps/admin-api/src/modules/content-management/comic（新增评论模块）
- 敏感词依赖：
  - 统一依赖公共敏感词模块 @libs/sensitive-word
- 实现约束：导出路径与现有 comic 模块风格一致
- 依赖关系：任务 02-07
- 验收标准：依赖注入正常、应用启动无报错
- 细化说明：
  - module 分层：controller/service/repository/dto
  - index.ts 统一导出，保持公共库规范

任务 12：反垃圾与频率限制配置
- 配置项：评论频率策略（如每分钟/每小时/每天的上限）
- 配置位置：系统配置（system-config 或独立配置表，保持全局可调）
- 实现约束：创建评论前校验配置，触发限流返回明确错误
- 依赖关系：任务 04
- 验收标准：配置可更新且对评论创建生效
- 细化说明：
  - 限流粒度：用户维度
  - 触发后提示：返回剩余冷却时间或提示语

任务 13：违规用户状态检验
- 校验规则：禁言/封禁用户不可创建评论
- 依赖关系：任务 04
- 验收标准：违规用户请求返回明确异常
- 细化说明：
  - 使用统一用户状态枚举
  - 响应码与论坛一致

任务 14：敏感词处罚策略配置
- 配置项：敏感词等级与处理动作（通过/待审/拒绝/隐藏）
- 实现约束：评论创建时按配置生成审核状态与隐藏策略
- 依赖关系：任务 04、07
- 验收标准：配置变更后策略生效
- 细化说明：
  - 配置示例：严重=拒绝+隐藏，一般=待审，轻微=通过
  - 可配置是否记录命中明细

任务 15：举报与审计留痕
- 数据表：work_comic_chapter_comment_report（或复用通用举报表）
- 字段清单：comment_id、reporter_id、reason、detail、status、handled_by、handled_at、created_at
- 审计留痕：评论创建/审核/隐藏/删除写入审计日志
- 依赖关系：任务 01、07、10
- 验收标准：举报可追踪，审计日志可查询
- 细化说明：
  - 举报状态：待处理/已处理/已驳回
  - 审计记录：包含操作者与动作类型

任务 16：数据一致性与回填策略
- 输入契约：已有章节历史 commentCount
- 输出契约：新增评论表后 commentCount 可重算
- 实现约束：提供重算脚本或后台接口（仅管理员可触发）
- 依赖关系：任务 01、08
- 验收标准：重算后 commentCount 与实际评论数一致
- 细化说明：
  - 仅统计审核通过且未隐藏的评论
  - 支持按章节或按作品维度重算

任务 17：测试与验证
- 测试范围：
  - 评论创建/删除/分页
  - 回复跨章节校验
  - canComment 禁止评论
  - 禁言/封禁用户不可评论
  - 一层楼中楼限制
  - 频率限制与配置策略
  - 敏感词处罚策略配置
  - 举报与审计留痕
  - 审核/隐藏对计数影响
- 验收标准：pnpm lint 与 pnpm type-check 通过
- 细化说明：
  - 覆盖楼中楼限制与跨章节回复
  - 覆盖敏感词策略与限流策略

可选增强（确认后再纳入范围）
- 评论点赞：新增 work_comic_chapter_comment_like 表与接口
- 成长事件与积分规则：新增 comic.chapter.comment 事件与积分规则

新增任务清单（2026-02-19）
任务 A1：为复杂逻辑补充注释（已完成）
- 目标：为复杂业务逻辑补充可维护性注释
- 改动文件：
  - apps/admin-api/src/modules/system/config/system-config.controller.ts
  - libs/content/src/comic/chapter-comment/comic-chapter-comment.service.ts
  - prisma/models/work/comic/work-comic-chapter-comment-report.prisma

任务 A2：抽离章节评论类型定义到独立文件（已完成）
- 目标：将章节评论相关类型从服务文件中抽离，统一导出复用
- 改动文件：
  - libs/content/src/comic/chapter-comment/comic-chapter-comment.types.ts
  - libs/content/src/comic/chapter-comment/comic-chapter-comment.service.ts
  - libs/content/src/comic/chapter-comment/index.ts

任务 A3：规则校验与质量检查（已完成）
- 目标：确保代码风格与类型检查通过
- 改动文件：无
