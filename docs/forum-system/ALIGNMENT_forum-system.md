# 论坛系统接入 - 对齐文档

## 1. 项目上下文分析

### 1.1 现有项目技术栈

**后端框架:**
- NestJS 11.x (基于 Fastify)
- TypeScript 5.x
- Prisma ORM 7.2.0 (PostgreSQL)

**核心架构模式:**
- Monorepo 结构 (apps + libs)
- 模块化设计 (每个功能独立模块)
- 分层架构 (Controller → Service → Repository)
- RESTful API 设计
- JWT 认证机制
- 软删除模式

**现有模块结构:**
```
apps/
├── admin-api/          # 管理后台 API
│   └── src/modules/
│       ├── auth/              # 认证模块
│       ├── content-management/ # 内容管理 (漫画、作者、分类、标签)
│       ├── system/            # 系统管理 (上传、审计)
│       └── user/              # 用户管理
└── client-api/         # 客户端 API
    └── src/modules/
        ├── config/            # 配置 (公告、页面)
        └── dictionary/        # 数据字典

libs/
├── base/              # 基础库 (数据库、认证、日志等)
├── client-config/     # 客户端配置
├── dictionary/        # 数据字典
└── member/            # 会员管理
```

### 1.2 现有漫画模块实现模式

**目录结构:**
```
content-management/
└── comic/
    ├── comic.module.ts              # 模块入口
    ├── core/                        # 核心功能
    │   ├── comic.controller.ts
    │   ├── comic.service.ts
    │   ├── comic.constant.ts       # 常量定义 (枚举)
    │   └── dto/
    │       └── comic.dto.ts         # 数据传输对象
    ├── chapter/                     # 章节子模块
    ├── chapter-content/             # 章节内容子模块
    └── third-party/                 # 第三方集成
```

**数据库模型:**
```
prisma/models/work/comic/
├── work-comic.prisma           # 漫画主表
├── work-comic-author.prisma    # 漫画-作者关联表
├── work-comic-category.prisma  # 漫画-分类关联表
├── work-comic-chapter.prisma   # 章节表
└── work-comic-tag.prisma       # 漫画-标签关联表
```

**代码规范:**
- 使用装饰器进行 API 文档和验证
- DTO 继承和组合模式
- Service 继承 RepositoryService
- 使用事务处理复杂更新
- 软删除机制
- 分页查询使用 findPagination 扩展

### 1.3 用户体系

**AdminUser (管理员):**
- 角色: role (SmallInt)
- 认证: JWT
- 权限: 基于角色的访问控制

**ClientUser (客户端用户):**
- 需要查看具体模型定义

### 1.4 路由规范

**管理后台路由:**
- 前缀: `/admin/{module}/{resource}`
- 示例: `/admin/work/comic/page`

**客户端路由:**
- 前缀: `/client/{module}/{resource}`
- 示例: `/client/config/notice/list`

## 2. 原始需求

接入 Zibll 子比主题论坛系统 (https://www.zibll.com/forums?index=2)，要求:

1. **架构隔离改造**
   - 独立的论坛模块目录结构
   - 独立的数据库表结构
   - 独立的路由前缀
   - 独立的权限控制系统

2. **功能集成改造**
   - 论坛内容展示、发布、评论、点赞
   - 独立的搜索功能
   - 独立的通知系统

3. **社区最佳实践实施**
   - 社区规则与版主管理制度
   - 内容审核机制 (人工 + AI)
   - 用户行为激励系统 (积分、等级、徽章)
   - 内容组织形式 (板块分类、标签体系)
   - 数据分析功能

4. **性能与安全优化**
   - 独立的缓存策略
   - 独立的 CDN 资源
   - 安全防护 (XSS、CSRF)
   - 防刷屏、反垃圾信息

5. **可扩展性设计**
   - 模块化架构
   - 插件机制
   - 预留 API 接口

## 3. 需求理解

### 3.1 论坛系统核心概念

基于 Zibll 子比主题的社区论坛功能，核心概念包括:

**内容层级:**
- 板块 (Section/Category) - 论坛的一级分类
- 主题 (Topic/Thread) - 用户发布的帖子
- 回复 (Reply/Comment) - 对主题的评论

**用户角色:**
- 普通用户 - 浏览、发布、评论
- 版主 - 管理指定板块
- 超级版主 - 管理所有板块
- 管理员 - 系统管理

**用户激励:**
- 积分 (Points) - 用户行为奖励
- 等级 (Level) - 基于积分的用户等级
- 徽章 (Badge) - 特殊成就标识

**内容管理:**
- 置顶 (Pinned) - 重要主题
- 精华 (Featured) - 优质内容
- 锁定 (Locked) - 禁止回复
- 删除 (Deleted) - 软删除

### 3.2 业务合理性分析

**与漫画模块的独立性:**
- 论坛是社区互动平台，漫画是内容消费平台
- 用户体系可以共享 (ClientUser)
- 但权限体系需要隔离 (论坛权限 ≠ 漫画权限)
- 数据完全独立，无交叉引用

**社区最佳实践:**
- 积分系统: 发布主题 +10, 回复 +5, 被点赞 +2
- 等级系统: 基于积分划分 (如: 新手 < 100, 进阶 100-1000, 专家 > 1000)
- 徽章系统: 活跃用户、优质作者、版主等
- 内容审核: 敏感词过滤 + 人工审核
- 防刷机制: 发布频率限制、IP 限制

**技术合理性:**
- 复用现有基础设施 (认证、日志、上传)
- 独立的数据模型 (forum 数据库 schema)
- 独立的缓存命名空间 (forum:*)
- 独立的 API 路由前缀 (/admin/forum/*, /client/forum/*)

## 4. 边界确认

### 4.1 包含范围

**第一阶段 (MVP):**
1. 论坛板块管理 (CRUD)
2. 主题发布与管理
3. 回复功能
4. 点赞/取消点赞
5. 基础搜索 (主题标题、内容)
6. 用户积分系统
7. 用户等级系统
8. 版主管理
9. 内容审核 (敏感词过滤)
10. 基础通知 (回复通知、点赞通知)

**第二阶段 (扩展):**
1. 徽章系统
2. 数据分析看板
3. 插件机制
4. 高级搜索 (标签、时间、用户)
5. 内容推荐算法
6. CDN 资源加速
7. 推送通知 (邮件、短信、APP推送)
8. 自动化测试

### 4.2 不包含范围

1. Zibll 主题的 WordPress 集成 (完全独立开发)
2. 实时聊天功能
3. 私信系统
4. 第三方登录 (已有 AdminUser 认证)
5. 论坛与漫画的内容互通

### 4.3 技术约束

1. 必须遵循现有项目代码规范
2. 必须使用 Prisma ORM
3. 必须使用 Fastify 框架
4. 必须实现软删除
5. 必须使用 DTO 验证
6. 必须使用装饰器进行 API 文档

## 5. 疑问澄清

### 5.1 需要确认的问题

1. **用户体系:**
   - 论坛用户是否使用现有的 ClientUser 表?
   - 是否需要创建独立的 ForumUser 表来存储论坛特定信息?

2. **权限系统:**
   - 论坛权限是使用位掩码 (bitmask) 还是独立表?
   - 版主权限是绑定到板块还是全局?

3. **积分系统:**
   - 积分规则是否需要可配置?
   - 积分是否可以兑换其他权益?

4. **内容审核:**
   - 敏感词库是否需要可配置?
   - AI 审核是否需要接入第三方服务?

5. **通知系统:**
   - 是否需要实时通知 (WebSocket)?
   - 还是仅使用数据库记录 + 轮询?

6. **搜索功能:**
   - 是否需要集成全文搜索引擎 (如 Elasticsearch)?
   - 还是使用数据库 LIKE 查询?

7. **数据分析:**
   - 需要哪些具体的数据指标?
   - 是否需要数据可视化?

### 5.2 智能决策 (基于现有项目模式)

**决策 1: 用户体系**
- 使用现有的 ClientUser 表
- 创建 ForumProfile 表存储论坛特定信息 (积分、等级、徽章等)
- 理由: 保持用户体系统一，避免重复

**决策 2: 权限系统**
- 使用位掩码 (bitmask) 存储论坛权限
- 版主权限绑定到板块 (每个版主可以管理多个板块)
- 理由: 项目已使用 bitmask (参考 comic.constant.ts)，性能好

**决策 3: 积分系统**
- 积分规则可配置 (存储在数据字典或配置表)
- 积分系统需要与漫画系统互通 (预留接口，未来支持漫画消费论坛积分)
- 理由: 灵活性高，便于后续扩展，实现用户积分统一管理

**决策 4: 内容审核**
- 敏感词库可配置 (存储在数据字典)
- 不需要 AI 辅助审核 (仅人工审核)
- 理由: MVP 阶段优先实现基础功能，降低复杂度

**决策 5: 通知系统**
- 使用数据库记录 + 轮询 (暂不使用 WebSocket)
- 不实现推送功能 (仅站内通知)
- 理由: 降低复杂度，MVP 阶段够用

**决策 6: 搜索功能**
- 使用数据库 LIKE 查询 (暂不集成 Elasticsearch)
- 理由: MVP 阶段够用，避免引入新依赖

**决策 7: 数据分析**
- 提供基础数据指标 (主题数、回复数、活跃用户数)
- 暂不实现数据可视化 (第二阶段)
- 理由: MVP 阶段够用

**决策 8: 文件存储**
- 文件存储在本地 (暂不使用 CDN)
- 理由: MVP 阶段够用，降低部署复杂度

**决策 9: 测试策略**
- 暂不实现自动化测试
- 理由: MVP 阶段优先功能开发，后续补充

## 6. 功能清单 (待审核)

### 6.1 管理后台功能

**板块管理:**
- 创建板块
- 更新板块信息
- 删除板块 (软删除)
- 板块排序
- 板块启用/禁用
- 查看板块详情
- 分页查询板块列表

**主题管理:**
- 查看所有主题
- 批量删除主题
- 批量置顶/取消置顶
- 批量加精/取消加精
- 批量锁定/解锁
- 批量移动到其他板块
- 分页查询主题列表
- 查看主题详情

**回复管理:**
- 查看所有回复
- 批量删除回复
- 分页查询回复列表
- 查看回复详情

**用户管理 (论坛):**
- 查看用户论坛资料
- 修改用户积分
- 修改用户等级
- 授予/撤销徽章
- 查看用户积分记录
- 查看用户行为日志

**版主管理:**
- 添加版主
- 移除版主
- 分配版主管理的板块
- 查看版主列表
- 查看版主操作日志

**内容审核:**
- 敏感词管理 (CRUD)
- 审核队列 (待审核内容)
- 批量通过/拒绝
- 查看审核历史

**系统配置:**
- 积分规则配置
- 等级规则配置
- 徽章配置
- 论坛基础设置

**数据分析:**
- 论坛概览 (主题数、回复数、用户数)
- 活跃度趋势
- 热门主题排行
- 活跃用户排行
- 板块数据统计

### 6.2 客户端功能

**板块浏览:**
- 查看板块列表
- 查看板块详情
- 查看板块下的主题列表

**主题发布:**
- 创建主题
- 编辑主题 (作者本人)
- 删除主题 (作者本人)
- 上传主题封面
- 添加主题标签

**主题浏览:**
- 查看主题详情
- 查看主题回复列表
- 点赞/取消点赞主题
- 收藏/取消收藏主题
- 分享主题

**回复功能:**
- 发布回复
- 编辑回复 (作者本人)
- 删除回复 (作者本人)
- 回复回复 (楼中楼)
- 点赞/取消点赞回复

**个人中心:**
- 查看我的主题
- 查看我的回复
- 查看我的收藏
- 查看我的积分
- 查看我的等级
- 查看我的徽章
- 查看积分记录
- 查看通知列表
- 标记通知已读

**搜索功能:**
- 搜索主题 (标题、内容)
- 搜索回复 (内容)
- 按板块筛选
- 按标签筛选
- 按时间筛选

**用户主页:**
- 查看用户资料
- 查看用户发布的主题
- 查看用户发布的回复
- 查看用户的徽章

## 7. 下一步行动

1. 等待用户审核功能清单
2. 确认疑问澄清中的决策是否合理
3. 根据反馈调整需求
4. 进入架构设计阶段 (DESIGN 文档)
