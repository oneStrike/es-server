# 论坛系统接入 - 共识文档

## 1. 需求确认

### 1.1 明确的需求描述

在现有漫画平台基础上，独立接入一个完整的论坛社区系统，参考 Zibll 子比主题论坛系统的功能，实现以下目标：

1. **架构隔离**: 论坛模块与漫画模块在代码、数据库、路由、权限等方面完全独立
2. **功能完整**: 实现论坛核心功能，包括板块管理、主题发布、回复系统、点赞收藏、搜索等
3. **社区管理**: 实现版主管理、内容审核、用户激励（积分、等级、徽章）等社区管理功能
4. **性能安全**: 实现缓存策略、安全防护、防刷机制等性能和安全优化
5. **可扩展性**: 采用模块化架构，预留扩展接口

### 1.2 技术实现方案

**技术栈:**
- 框架: NestJS 11.x (Fastify)
- 语言: TypeScript 5.x
- ORM: Prisma 7.2.0
- 数据库: PostgreSQL
- 缓存: Redis (独立命名空间)

**架构设计:**
- 模块化设计，遵循现有项目架构
- 分层架构: Controller → Service → Repository
- 独立的数据库表前缀: `forum_`
- 独立的路由前缀: `/admin/forum/*`, `/client/forum/*`
- 独立的权限系统: 基于位掩码 (bitmask)

**用户体系:**
- 复用现有 ClientUser 表
- 创建 ForumProfile 表存储论坛特定信息
- 积分系统与漫画系统互通，预留接口

**文件存储:**
- 文件存储在本地
- 暂不使用 CDN

**通知系统:**
- 使用数据库记录 + 轮询
- 不实现推送功能 (仅站内通知)

**搜索功能:**
- 使用数据库 LIKE 查询
- 暂不集成 Elasticsearch

**内容审核:**
- 敏感词库可配置
- 仅人工审核，不需要 AI 辅助审核

**测试策略:**
- 暂不实现自动化测试

### 1.3 技术约束和集成方案

**必须遵循的约束:**
1. 必须遵循现有项目代码规范
2. 必须使用 Prisma ORM
3. 必须使用 Fastify 框架
4. 必须实现软删除
5. 必须使用 DTO 验证
6. 必须使用装饰器进行 API 文档
7. 必须继承 RepositoryService 复用通用方法

**集成方案:**
1. 复用现有认证体系 (JWT)
2. 复用现有上传模块
3. 复用现有缓存模块 (独立命名空间)
4. 复用现有日志模块
5. 复用现有数据字典模块

### 1.4 任务边界限制

**包含的功能 (MVP 阶段):**

**管理后台功能:**
1. 板块管理 (CRUD、排序、启用/禁用)
2. 主题管理 (查看、批量删除、置顶、加精、锁定、移动)
3. 回复管理 (查看、批量删除)
4. 用户管理 (查看资料、修改积分/等级、授予徽章、查看记录)
5. 版主管理 (添加/移除、分配板块、查看日志)
6. 内容审核 (敏感词管理、审核队列、批量处理)
7. 系统配置 (积分规则、等级规则、徽章配置、基础设置)
8. 数据分析 (论坛概览、活跃度趋势、热门排行)

**客户端功能:**
1. 板块浏览 (列表、详情、主题列表)
2. 主题发布 (创建、编辑、删除、上传封面、添加标签)
3. 主题浏览 (详情、回复列表、点赞、收藏、分享)
4. 回复功能 (发布、编辑、删除、楼中楼、点赞)
5. 个人中心 (我的主题/回复/收藏/积分/等级/徽章、积分记录、通知列表)
6. 搜索功能 (搜索主题/回复、按板块/标签/时间筛选)
7. 用户主页 (资料、主题、回复、徽章)

**不包含的功能 (MVP 阶段):**
1. 徽章系统 (第二阶段)
2. 数据可视化 (第二阶段)
3. AI 辅助审核 (不需要)
4. 插件机制 (第二阶段)
5. CDN 资源加速 (第二阶段)
6. 推送通知 (第二阶段)
7. 自动化测试 (第二阶段)
8. 实时聊天功能
9. 私信系统
10. 第三方登录
11. 论坛与漫画的内容互通

### 1.5 验收标准

**功能完整性:**
- 所有 MVP 阶段功能已实现
- 功能符合社区最佳实践
- 业务逻辑合理

**代码质量:**
- 代码符合项目规范
- 代码风格与现有代码一致
- 使用项目现有的工具和库
- 复用项目现有组件
- 代码精简易读

**技术要求:**
- 项目编译通过
- API 接口文档完整
- 数据库表结构正确
- 软删除机制实现
- DTO 验证完整
- 异常处理完善

**性能和安全:**
- 实现缓存策略 (独立命名空间)
- 实现安全防护 (XSS、CSRF)
- 实现防刷机制 (频率限制)
- 实现敏感词过滤

**集成要求:**
- 与现有系统集成良好
- 不影响现有功能
- 用户体系复用 ClientUser
- 积分系统预留与漫画互通接口

## 2. 智能决策确认

### 2.1 用户体系
**决策**: 复用现有 ClientUser 表，创建 ForumProfile 表存储论坛特定信息
**理由**: 保持用户体系统一，避免重复

### 2.2 权限系统
**决策**: 使用位掩码 (bitmask) 存储论坛权限，版主权限绑定到板块
**理由**: 项目已使用 bitmask，性能好

### 2.3 积分系统
**决策**: 积分规则可配置，积分系统需要与漫画系统互通
**理由**: 灵活性高，便于后续扩展，实现用户积分统一管理

### 2.4 内容审核
**决策**: 敏感词库可配置，不需要 AI 辅助审核 (仅人工审核)
**理由**: MVP 阶段优先实现基础功能，降低复杂度

### 2.5 通知系统
**决策**: 使用数据库记录 + 轮询，不实现推送功能 (仅站内通知)
**理由**: 降低复杂度，MVP 阶段够用

### 2.6 搜索功能
**决策**: 使用数据库 LIKE 查询，暂不集成 Elasticsearch
**理由**: MVP 阶段够用，避免引入新依赖

### 2.7 数据分析
**决策**: 提供基础数据指标，暂不实现数据可视化
**理由**: MVP 阶段够用

### 2.8 文件存储
**决策**: 文件存储在本地，暂不使用 CDN
**理由**: MVP 阶段够用，降低部署复杂度

### 2.9 测试策略
**决策**: 暂不实现自动化测试
**理由**: MVP 阶段优先功能开发，后续补充

## 3. 项目特性规范

### 3.1 命名规范

**数据库表命名:**
- 前缀: `forum_`
- 格式: 小写 + 下划线
- 示例: `forum_section`, `forum_topic`, `forum_reply`

**字段命名:**
- 格式: 小写 + 下划线
- 时间字段: `created_at`, `updated_at`, `deleted_at`
- 状态字段: `is_enabled`, `is_published`
- 外键字段: `{表名}_id`

**代码命名:**
- 类名: PascalCase (如 `ForumTopicService`)
- 方法名: camelCase (如 `createTopic`)
- 常量: UPPER_SNAKE_CASE (如 `TOPIC_STATUS_PUBLISHED`)

### 3.2 路由规范

**管理后台路由:**
- 前缀: `/admin/forum`
- 格式: `/admin/forum/{子模块}/{操作}`
- 示例: `/admin/forum/section/create`, `/admin/forum/topic/page`

**客户端路由:**
- 前缀: `/client/forum`
- 格式: `/client/forum/{子模块}/{操作}`
- 示例: `/client/forum/topic/create`, `/client/forum/topic/detail`

### 3.3 代码规范

**Controller 层:**
- 使用装饰器定义路由
- 使用 DTO 验证请求参数
- 使用装饰器生成 API 文档
- 异常处理使用标准异常类

**Service 层:**
- 继承 RepositoryService 复用通用方法
- 使用事务处理复杂操作
- 业务逻辑清晰
- 注释完整

**DTO 层:**
- 使用 class-validator 进行验证
- 使用装饰器定义验证规则
- 继承和组合模式复用

**数据库操作:**
- 使用 Prisma Client
- 实现软删除
- 使用索引优化查询
- 事务处理保证数据一致性

### 3.4 文档规范

**API 文档:**
- 使用 @nestjs/swagger 自动生成
- 每个接口添加描述
- 参数说明完整
- 响应示例完整

**代码注释:**
- 关键逻辑添加注释
- 复杂业务逻辑添加说明
- 遵循项目注释规范

## 4. 不确定性确认

所有关键决策已确认，不存在不确定性。

## 5. 下一步行动

1. 创建 DESIGN 文档 (架构设计阶段)
2. 设计系统架构图
3. 设计数据库表结构
4. 设计接口契约
5. 设计模块依赖关系
