 # ALIGNMENT_user-growth-optimization

 ## 原始需求

 - 全面优化用户成长体系
 - 按 6A 工作流输出文档，等待确认后再进入实施

 ## 项目与任务特性

 - 技术栈：NestJS + Prisma
 - 领域边界：成长事件、反作弊、审计、积分、经验、等级、徽章、概览与管理端接口
 - 关键目标：提升性能与可维护性，降低查询成本与并发写争用风险，完善可观测性

 ## 现状理解（基于代码与既有文档）

 - 业务通过 UserGrowthEventService 发布成长事件到本地事件总线
 - 成长事件消费链路包含幂等、审计、防刷、规则匹配与发放
 - 发放在事务内完成，并触发等级重算
 - 管理端提供事件审计与成长概览接口

 ## 任务范围

 - 反作弊：冷却与计数查询优化、配置加载优化、命中原因可观测性
 - 审计：幂等窗口查询优化、索引覆盖、归档策略与失败原因沉淀
 - 规则与发放：批量查询与内存过滤、减少 N+1、并发写争用控制
 - 等级计算：规则读取与计算优化，统一入口避免漂移
 - 概览与管理端：聚合查询优化与索引评估

 ## 非范围

 - 前端 UI 深度重构
 - 引入外部 MQ 或分布式事件存储
 - 改变业务域事件生产逻辑与事件语义

 ## 关键假设

 - 允许在保持业务语义不变的前提下调整查询与缓存策略
 - 允许新增必要索引与少量表字段（若确有必要）
 - 优化以性能与可维护性为主，不改变对外 API 契约

 ## 待确认的歧义点

 - 是否接受为反作弊与规则查询引入短 TTL 缓存
 - 是否接受为审计与发放新增结构化错误字段
 - 是否允许对成长事件相关表新增或调整索引
