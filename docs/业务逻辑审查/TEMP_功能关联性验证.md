# 功能关联性验证

## 检查概述

本文档记录了Forum模块核心服务之间的功能关联性验证结果，确保各模块之间的依赖关系正确实现。

## 检查标准

- **依赖注入**: 服务之间通过依赖注入正确关联
- **数据关联**: 实体之间的外键关系正确建立
- **业务关联**: 业务流程中的模块调用逻辑正确
- **事务一致性**: 跨模块操作使用事务保证数据一致性

## 核心模块关联关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        ForumTopicService                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 依赖: PointService, ForumConfigCacheService,               │  │
│  │      SensitiveWordDetectService                            │  │
│  │ 关联: ForumSection, ForumProfile, ForumTag                 │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 创建主题 → 添加积分
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        PointService                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 关联: ForumProfile, ForumPointRule, ForumPointRecord      │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↑
                              │ 查询积分记录
                              │
┌─────────────────────────────────────────────────────────────────┐
│                          UserService                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 依赖: PointService                                         │  │
│  │ 关联: ForumProfile, ForumTopic, ForumTopicFavorite,       │  │
│  │      ForumPointRecord                                      │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 创建回复
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        ForumReplyService                        │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 依赖: NotificationService, SensitiveWordDetectService     │  │
│  │ 关联: ForumTopic, ForumProfile, ForumReply(嵌套),         │  │
│  │      ForumSection                                         │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 发送通知
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      NotificationService                        │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 关联: ForumProfile, ForumTopic, ForumReply               │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 详细关联分析

### 1. ForumTopicService（主题服务）

#### 依赖注入关系

| 依赖服务 | 用途 | 调用方法 |
|---------|------|---------|
| PointService | 创建主题后添加积分 | addPoints() |
| ForumConfigCacheService | 获取审核策略 | getConfig() |
| SensitiveWordDetectService | 检测敏感词 | getMatchedWords() |

#### 数据关联关系

| 关联实体 | 关系类型 | 关联字段 | 用途 |
|---------|---------|---------|------|
| ForumSection | 多对一 | sectionId | 主题所属版块 |
| ForumProfile | 多对一 | profileId | 主题作者 |
| ForumTag | 多对多 | topicTags | 主题标签 |
| ForumReply | 一对多 | topicId | 主题的回复 |

#### 业务流程关联

**创建主题流程**:
1. 检测敏感词 → SensitiveWordDetectService
2. 获取审核策略 → ForumConfigCacheService
3. 计算审核状态
4. 创建主题记录
5. 添加积分 → PointService（仅在审核通过后）

**删除主题流程**:
1. 查找主题
2. 使用事务删除所有关联回复
3. 软删除主题

**关联完整性**: ✓ 完整

---

### 2. ForumReplyService（回复服务）

#### 依赖注入关系

| 依赖服务 | 用途 | 调用方法 |
|---------|------|---------|
| NotificationService | 回复通知 | createReplyNotification() |
| SensitiveWordDetectService | 检测敏感词 | detect() |

#### 数据关联关系

| 关联实体 | 关系类型 | 关联字段 | 用途 |
|---------|---------|---------|------|
| ForumTopic | 多对一 | topicId | 回复所属主题 |
| ForumProfile | 多对一 | profileId | 回复作者 |
| ForumReply | 自关联 | replyToId | 被回复的回复 |
| ForumReply | 一对多 | replyToId | 子回复 |

#### 业务流程关联

**创建回复流程**:
1. 验证主题存在且未锁定
2. 验证用户资料存在且未封禁
3. 验证父回复存在（如果是回复回复）
4. 计算楼层号（仅主回复）
5. 检测敏感词 → SensitiveWordDetectService
6. 使用事务创建回复
7. 更新主题回复数
8. 更新版块回复数
9. 更新用户回复数
10. 发送回复通知 → NotificationService（如果是回复他人）

**删除回复流程**:
1. 查找回复
2. 使用事务删除所有子回复
3. 更新主题回复数
4. 更新版块回复数
5. 更新用户回复数
6. 软删除回复

**关联完整性**: ✓ 完整

---

### 3. UserService（用户服务）

#### 依赖注入关系

| 依赖服务 | 用途 | 调用方法 |
|---------|------|---------|
| PointService | 查询积分记录 | getPointRecords() |

#### 数据关联关系

| 关联实体 | 关系类型 | 关联字段 | 用途 |
|---------|---------|---------|------|
| ForumProfile | 一对一 | userId | 用户论坛资料 |
| ForumTopic | 一对多 | userId | 用户创建的主题 |
| ForumTopicFavorite | 一对多 | userId | 用户收藏的主题 |
| ForumPointRecord | 一对多 | userId | 用户积分记录 |

#### 业务流程关联

**查询用户资料流程**:
1. 查找用户资料
2. 包含用户信息
3. 包含徽章信息

**查询我的主题流程**:
1. 查询用户创建的主题
2. 包含版块信息
3. 包含回复数统计

**查询我的收藏流程**:
1. 查询用户收藏记录
2. 包含主题信息
3. 包含回复数统计

**查询积分记录流程**:
1. 查询用户积分记录
2. 分页返回

**关联完整性**: ✓ 完整

---

### 4. ExperienceService（经验服务）

#### 依赖注入关系

| 依赖服务 | 用途 | 调用方法 |
|---------|------|---------|
| 无 | - | - |

#### 数据关联关系

| 关联实体 | 关系类型 | 关联字段 | 用途 |
|---------|---------|---------|------|
| ForumProfile | 多对一 | profileId | 经验归属用户 |
| ForumExperienceRule | 多对一 | ruleId | 经验规则 |
| ForumExperienceRecord | 一对多 | profileId | 用户经验记录 |

#### 业务流程关联

**增加经验流程**:
1. 验证用户资料存在且未永久封禁
2. 查找启用的经验规则
3. 检查今日经验上限
4. 使用事务创建经验记录
5. 更新用户经验值

**关联完整性**: ✓ 完整

---

### 5. PointService（积分服务）

#### 依赖注入关系

| 依赖服务 | 用途 | 调用方法 |
|---------|------|---------|
| 无 | - | - |

#### 数据关联关系

| 关联实体 | 关系类型 | 关联字段 | 用途 |
|---------|---------|---------|------|
| ForumProfile | 多对一 | profileId | 积分归属用户 |
| ForumPointRule | 多对一 | ruleId | 积分规则 |
| ForumPointRecord | 一对多 | profileId | 用户积分记录 |

#### 业务流程关联

**增加积分流程**:
1. 验证用户资料存在
2. 查找启用的积分规则
3. 检查今日积分上限
4. 使用事务创建积分记录
5. 更新用户积分值

**消费积分流程**:
1. 验证用户资料存在
2. 检查积分是否充足
3. 使用事务创建积分记录
4. 更新用户积分值

**与漫画系统互通流程**:
1. 验证用户资料存在
2. 检查积分是否充足（消费时）
3. 使用事务更新用户积分

**关联完整性**: ✓ 完整

---

### 6. SensitiveWordService（敏感词服务）

#### 依赖注入关系

| 依赖服务 | 用途 | 调用方法 |
|---------|------|---------|
| ForumSensitiveWordCacheService | 缓存管理 | invalidateAll() |
| SensitiveWordDetectService | 敏感词检测 | reloadWords() |

#### 数据关联关系

| 关联实体 | 关系类型 | 关联字段 | 用途 |
|---------|---------|---------|------|
| 无 | - | - | - |

#### 业务流程关联

**创建敏感词流程**:
1. 创建敏感词记录
2. 清空缓存 → ForumSensitiveWordCacheService
3. 重新加载敏感词 → SensitiveWordDetectService

**更新敏感词流程**:
1. 验证敏感词存在
2. 更新敏感词记录
3. 清空缓存 → ForumSensitiveWordCacheService
4. 重新加载敏感词 → SensitiveWordDetectService

**删除敏感词流程**:
1. 删除敏感词记录
2. 清空缓存 → ForumSensitiveWordCacheService
3. 重新加载敏感词 → SensitiveWordDetectService

**关联完整性**: ✓ 完整

---

### 7. ForumConfigService（论坛配置服务）

#### 依赖注入关系

| 依赖服务 | 用途 | 调用方法 |
|---------|------|---------|
| ForumConfigCacheService | 缓存管理 | invalidateConfig() |

#### 数据关联关系

| 关联实体 | 关系类型 | 关联字段 | 用途 |
|---------|---------|---------|------|
| ForumConfigHistory | 一对多 | configId | 配置历史记录 |
| AdminUser | 多对一 | updatedById | 更新操作者 |

#### 业务流程关联

**更新配置流程**:
1. 验证用户存在
2. 查找现有配置
3. 更新配置记录
4. 记录配置变更历史
5. 清空缓存 → ForumConfigCacheService

**从历史记录恢复流程**:
1. 验证用户存在
2. 查找历史记录
3. 查找当前配置
4. 提取恢复数据
5. 更新配置记录
6. 记录恢复操作历史
7. 清空缓存 → ForumConfigCacheService

**关联完整性**: ✓ 完整

---

## 跨模块事务一致性检查

### 1. 创建主题事务

| 操作 | 涉及模块 | 事务保护 |
|------|---------|---------|
| 创建主题 | ForumTopicService | ✗ 无事务 |
| 添加积分 | PointService | ✗ 无事务 |

**问题**: 创建主题和添加积分未在同一事务中，可能导致积分添加失败但主题已创建。

**建议**: 考虑将积分添加操作移到主题创建事务中，或使用补偿机制。

---

### 2. 创建回复事务

| 操作 | 涉及模块 | 事务保护 |
|------|---------|---------|
| 创建回复 | ForumReplyService | ✓ 有事务 |
| 更新主题回复数 | ForumReplyService | ✓ 有事务 |
| 更新版块回复数 | ForumReplyService | ✓ 有事务 |
| 更新用户回复数 | ForumReplyService | ✓ 有事务 |
| 发送通知 | NotificationService | ✗ 无事务 |

**问题**: 发送通知操作未在事务中，可能导致通知发送失败但回复已创建。

**建议**: 通知操作可以异步处理，或使用消息队列保证最终一致性。

---

### 3. 删除主题事务

| 操作 | 涉及模块 | 事务保护 |
|------|---------|---------|
| 删除所有回复 | ForumTopicService | ✓ 有事务 |
| 删除主题 | ForumTopicService | ✓ 有事务 |

**完整性**: ✓ 完整

---

### 4. 删除回复事务

| 操作 | 涉及模块 | 事务保护 |
|------|---------|---------|
| 删除子回复 | ForumReplyService | ✓ 有事务 |
| 更新主题回复数 | ForumReplyService | ✓ 有事务 |
| 更新版块回复数 | ForumReplyService | ✓ 有事务 |
| 更新用户回复数 | ForumReplyService | ✓ 有事务 |
| 删除回复 | ForumReplyService | ✓ 有事务 |

**完整性**: ✓ 完整

---

### 5. 增加经验事务

| 操作 | 涉及模块 | 事务保护 |
|------|---------|---------|
| 创建经验记录 | ExperienceService | ✓ 有事务 |
| 更新用户经验 | ExperienceService | ✓ 有事务 |

**完整性**: ✓ 完整

---

### 6. 增加积分事务

| 操作 | 涉及模块 | 事务保护 |
|------|---------|---------|
| 创建积分记录 | PointService | ✓ 有事务 |
| 更新用户积分 | PointService | ✓ 有事务 |

**完整性**: ✓ 完整

---

### 7. 消费积分事务

| 操作 | 涉及模块 | 事务保护 |
|------|---------|---------|
| 创建积分记录 | PointService | ✓ 有事务 |
| 更新用户积分 | PointService | ✓ 有事务 |

**完整性**: ✓ 完整

---

## 缓存一致性检查

### 1. 敏感词缓存

| 操作 | 缓存更新 | 一致性 |
|------|---------|--------|
| 创建敏感词 | ✓ 清空并重新加载 | ✓ 完整 |
| 更新敏感词 | ✓ 清空并重新加载 | ✓ 完整 |
| 删除敏感词 | ✓ 清空并重新加载 | ✓ 完整 |
| 更新敏感词状态 | ✓ 清空并重新加载 | ✓ 完整 |

**完整性**: ✓ 完整

---

### 2. 论坛配置缓存

| 操作 | 缓存更新 | 一致性 |
|------|---------|--------|
| 更新配置 | ✓ 清空缓存 | ✓ 完整 |
| 重置为默认 | ✓ 清空缓存 | ✓ 完整 |
| 从历史恢复 | ✓ 清空缓存 | ✓ 完整 |

**完整性**: ✓ 完整

---

## 数据统计关联检查

### 1. 主题统计

| 统计项 | 更新位置 | 关联模块 | 一致性 |
|-------|---------|---------|--------|
| 回复数 | 创建/删除回复 | ForumReplyService | ✓ 完整 |
| 查看数 | 查看主题 | ForumViewService | ✓ 完整 |
| 点赞数 | 点赞/取消点赞 | ForumTopicLikeService | ✓ 完整 |
| 收藏数 | 收藏/取消收藏 | ForumTopicFavoriteService | ✓ 完整 |

**完整性**: ✓ 完整

---

### 2. 版块统计

| 统计项 | 更新位置 | 关联模块 | 一致性 |
|-------|---------|---------|--------|
| 主题数 | 创建/删除主题 | ForumTopicService | ✗ 未验证 |
| 回复数 | 创建/删除回复 | ForumReplyService | ✓ 完整 |

**问题**: 版块主题数统计未验证是否正确更新。

**建议**: 检查ForumTopicService是否在创建/删除主题时更新版块主题数。

---

### 3. 用户统计

| 统计项 | 更新位置 | 关联模块 | 一致性 |
|-------|---------|---------|--------|
| 主题数 | 创建/删除主题 | ForumTopicService | ✗ 未验证 |
| 回复数 | 创建/删除回复 | ForumReplyService | ✓ 完整 |
| 经验值 | 增加经验 | ExperienceService | ✓ 完整 |
| 积分值 | 增加/消费积分 | PointService | ✓ 完整 |

**问题**: 用户主题数统计未验证是否正确更新。

**建议**: 检查ForumTopicService是否在创建/删除主题时更新用户主题数。

---

## 发现的问题

### 高优先级问题

1. **创建主题时积分添加未使用事务**
   - 影响: 可能导致积分添加失败但主题已创建
   - 建议: 将积分添加操作移到主题创建事务中，或使用补偿机制
   - 位置: ForumTopicService.createForumTopic()

2. **版块主题数统计未验证**
   - 影响: 版块主题数可能不准确
   - 建议: 检查并确保创建/删除主题时更新版块主题数
   - 位置: ForumTopicService

3. **用户主题数统计未验证**
   - 影响: 用户主题数可能不准确
   - 建议: 检查并确保创建/删除主题时更新用户主题数
   - 位置: ForumTopicService

### 中优先级问题

1. **创建回复时发送通知未使用事务**
   - 影响: 可能导致通知发送失败但回复已创建
   - 建议: 通知操作可以异步处理，或使用消息队列保证最终一致性
   - 位置: ForumReplyService.createForumReply()

---

## 结论

Forum模块的功能关联性整体良好，各模块之间的依赖关系正确实现，大部分业务流程使用了事务保证数据一致性。主要发现的问题包括：

1. **事务一致性**: 创建主题时积分添加未使用事务，可能导致数据不一致
2. **统计完整性**: 版块主题数和用户主题数的更新未验证
3. **通知机制**: 回复通知未在事务中，可能导致通知丢失

建议优先解决高优先级问题，以提升系统的数据一致性和可靠性。
