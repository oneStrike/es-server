# Dockerfile和PM2配置文件拆分 - CONSENSUS文档
## 明确的需求描述

### 目标
将现有的统一Dockerfile和PM2配置文件拆分为两个独立的服务配置：
- `admin-api` 服务独立配置
- `client-api` 服务独立配置

### 验收标准
1. ✅ 每个服务有独立的Dockerfile
2. ✅ 每个服务有独立的PM2配置文件
3. ✅ 支持独立构建和部署
4. ✅ 镜像大小优化（不包含无关服务代码）
5. ✅ 保持现有的安全性和性能特性
6. ✅ 更新构建和部署脚本

## 技术实现方案

### 文件结构
```
apps/
├── admin-api/
│   ├── Dockerfile              # 新的：admin-api专用Dockerfile
│   ├── ecosystem.config.cjs    # 新的：admin-api专用PM2配置
│   └── ...                     # 现有文件保持不变
├── client-api/
│   ├── Dockerfile              # 新的：client-api专用Dockerfile
│   ├── ecosystem.config.cjs    # 新的：client-api专用PM2配置
│   └── ...                     # 现有文件保持不变
```

### Dockerfile设计原则
1. **多阶段构建**：保持现有的builder和runtime阶段
2. **最小化镜像**：只复制当前服务的代码和依赖
3. **安全配置**：保持非root用户、权限设置
4. **缓存优化**：保持pnpm缓存和构建缓存
5. **端口配置**：admin-api使用8080，client-api使用8081

### PM2配置设计原则
1. **独立进程**：每个服务独立的PM2应用配置
2. **环境变量**：支持独立的环境变量配置
3. **日志管理**：保持现有的日志轮转配置
4. **健康检查**：admin-api使用/api/ready，client-api使用/api/health

## 技术约束和集成方案

### 构建约束
- 使用现有的webpack配置
- 保持现有的构建脚本接口
- 支持pnpm workspaces

### 部署约束
- 支持独立部署
- 保持现有的Docker运行参数
- 支持环境变量配置

### 集成方案
1. **构建集成**：更新package.json脚本，支持分别构建
2. **部署集成**：支持独立的服务部署
3. **监控集成**：保持现有的PM2监控配置

## 任务边界限制

### 包含的任务
- ✅ 创建admin-api的Dockerfile
- ✅ 创建client-api的Dockerfile
- ✅ 创建admin-api的PM2配置
- ✅ 创建client-api的PM2配置
- ✅ 更新根目录构建脚本
- ✅ 删除根目录旧配置文件

### 不包含的任务
- ❌ 修改应用业务逻辑
- ❌ 修改数据库配置
- ❌ 修改共享模块代码
- ❌ 修改webpack构建配置
- ❌ 修改Prisma配置

## 确认所有不确定性已解决

### 已确认的事项
1. ✅ 两个服务使用不同的端口（8080 vs 8081）
2. ✅ 两个服务有不同的健康检查端点
3. ✅ 保持现有的安全配置
4. ✅ 保持现有的缓存优化
5. ✅ 支持独立部署

### 项目特性规范已对齐
1. **代码复用**：共享依赖通过pnpm workspaces处理
2. **构建优化**：保持现有的webpack和缓存配置
3. **安全标准**：保持现有的用户权限和安全配置
4. **监控标准**：保持现有的PM2监控和日志配置
5. **部署标准**：支持独立部署和扩展

## 质量门控

### 需求边界清晰无歧义
- ✅ 明确区分admin-api和client-api的配置需求
- ✅ 明确每个服务的独立部署需求
- ✅ 明确保持现有特性的需求

### 技术方案与现有架构对齐
- ✅ 保持现有的monorepo结构
- ✅ 保持现有的构建工具链
- ✅ 保持现有的部署流程
- ✅ 保持现有的安全标准

### 验收标准具体可测试
- ✅ 每个服务可以独立构建
- ✅ 每个服务可以独立运行
- ✅ 镜像大小得到优化
- ✅ 配置文件功能完整

### 所有关键假设已确认
- ✅ 两个服务可以独立运行
- ✅ 共享依赖可以正确处理
- ✅ 构建缓存可以正确工作
- ✅ 部署流程可以独立执行
