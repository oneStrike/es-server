# Dockerfile和PM2配置文件拆分 - 待办事项
## 立即需要处理的事项

### 🔴 高优先级

#### 1. 测试CI工作流
**描述**：验证更新后的CI工作流是否能正常构建两个独立服务
**操作建议**：
- 推送代码到main分支触发CI工作流
- 检查工作流执行状态
- 验证镜像构建和测试结果
- 检查构建环境调试信息

**修复内容**：
- ✅ 添加缓存目录创建步骤
- ✅ 修复Dockerfile中test目录复制问题
- ✅ 添加构建环境检查调试信息
- ✅ 优化缓存配置参数

#### 2. 测试新的Docker构建流程
**描述**：验证新创建的Dockerfile是否能正常构建和运行
**操作建议**：
```bash
# 测试admin-api构建
cd d:/code/es/es-server
pnpm docker:build:admin

# 测试client-api构建
pnpm docker:build:client

# 验证镜像创建
docker images | grep -E "(admin-api|client-api)"
```

#### 3. 验证PM2配置
**描述**：测试新的PM2配置文件是否正常工作
**操作建议**：
```bash
# 测试admin-api PM2配置
cd apps/admin-api
pm2 start ecosystem.config.cjs --env development

# 测试client-api PM2配置
cd ../client-api
pm2 start ecosystem.config.cjs --env development

# 检查状态
pm2 status
```

#### 4. 端口冲突检查
**描述**：确认8080和8081端口在部署环境中可用
**操作建议**：
- 检查生产环境防火墙设置
- 确认端口映射配置
- 更新部署脚本中的端口配置

### 🟡 中优先级

#### 5. 更新部署文档
**描述**：更新项目的部署和运维文档
**操作建议**：
- 更新README.md中的部署说明
- 更新运维手册中的服务管理命令
- 添加新架构的说明文档
- 添加CI工作流使用说明

#### 6. 环境变量配置
**描述**：确认各服务的环境变量配置是否完整
**操作建议**：
- 检查admin-api的JWT_SECRET等敏感配置
- 检查client-api的数据库连接配置
- 确认日志路径和轮转配置

#### 7. 健康检查端点验证
**描述**：验证各服务的健康检查端点是否正常工作
**操作建议**：
- 测试admin-api的`/api/ready`端点
- 测试client-api的`/api/health`端点
- 确认健康检查响应格式

### 🟢 低优先级

#### 8. 性能基准测试
**描述**：对比拆分前后的性能表现
**操作建议**：
- 测试镜像大小变化
- 测试启动时间变化
- 测试内存使用情况

#### 9. 监控配置更新
**描述**：更新监控和告警配置
**操作建议**：
- 更新PM2监控配置
- 配置独立的服务监控
- 设置告警规则

#### 10. 自动化部署脚本
**描述**：创建完整的自动化部署脚本
**操作建议**：
- 创建部署脚本，支持蓝绿部署
- 添加回滚机制
- 集成健康检查和监控

## 配置检查清单

### CI工作流配置
- [ ] Admin API构建工作流测试
- [ ] Client API构建工作流测试
- [ ] 镜像保存和加载测试
- [ ] 容器启动测试验证

### Docker配置
- [ ] admin-api Dockerfile构建测试
- [ ] client-api Dockerfile构建测试
- [ ] 镜像大小优化验证
- [ ] 安全配置检查

### PM2配置
- [ ] admin-api PM2配置测试
- [ ] client-api PM2配置测试
- [ ] 日志轮转配置验证
- [ ] 环境变量配置检查

### 端口配置
- [ ] 8080端口可用性检查
- [ ] 8081端口可用性检查
- [ ] 防火墙规则更新
- [ ] 负载均衡配置更新

### 环境变量
- [ ] admin-api环境变量配置
- [ ] client-api环境变量配置
- [ ] 敏感信息加密配置
- [ ] 开发/生产环境配置分离

## 风险和注意事项

### ⚠️ 重要提醒
1. **备份现有配置**：在测试新配置前，请备份现有的部署配置
2. **逐步迁移**：建议先在测试环境验证，再迁移到生产环境
3. **监控告警**：确保迁移过程中有完善的监控和告警机制
4. **回滚计划**：准备完整的回滚方案，以防出现问题

### 🔧 技术细节
1. **Prisma配置**：确保Prisma客户端在独立环境中能正常生成
2. **共享依赖**：确认共享模块在独立构建时能正确引用
3. **文件权限**：验证Docker容器内的文件权限设置
4. **日志路径**：确认日志文件的挂载和轮转配置

## 联系和支持

### 需要帮助时请联系
1. **技术咨询**：联系系统架构师或DevOps工程师
2. **部署支持**：联系运维团队
3. **问题反馈**：通过项目管理工具提交问题单

### 相关文档
- `docs/docker-split/ALIGNMENT_docker_split.md` - 需求分析和设计文档
- `docs/docker-split/DESIGN_docker_split.md` - 架构设计文档
- `docs/docker-split/ACCEPTANCE_docker_split.md` - 验收文档
- `docs/docker-split/FINAL_docker_split.md` - 项目总结报告

## 更新时间
最后更新时间：2025年11月26日

**注意**：请在开始测试前仔细阅读本文档，并按照优先级顺序逐步执行。如有任何问题，请及时寻求技术支持。
