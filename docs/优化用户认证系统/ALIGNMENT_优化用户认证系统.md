# ALIGNMENT_优化用户认证系统

## 1. 项目上下文分析

### 1.1 现有项目结构

#### 技术栈
- **框架**: NestJS + Fastify
- **数据库**: PostgreSQL + Prisma ORM
- **认证**: JWT (Access Token + Refresh Token)
- **加密**: RSA (数据传输加密) + Scrypt (密码哈希)
- **短信服务**: 阿里云短信服务
- **架构**: Monorepo结构，包含libs/base、apps/app-api、apps/admin-api

#### 现有认证系统架构
- **AppUser模型**: 包含id, account, nickname, password, phone, email, isEnabled, gender, birthDate, isSignedIn, lastLoginAt, lastLoginIp等字段
- **AuthService**: 提供注册、登录、登出、刷新令牌、忘记密码、重置密码功能
- **Token管理**: AppTokenStorageService管理Token生命周期，支持Redis缓存
- **安全机制**: 
  - RSA加密传输密码
  - Scrypt哈希存储密码
  - JWT双Token机制
  - 设备管理和撤销功能

#### 现有代码模式
- 使用BaseService作为基类，提供prisma访问
- 使用DTO进行数据验证和API文档
- 使用装饰器进行路由配置和文档生成
- 使用事务处理数据库操作
- 错误信息集中管理在constant文件中

### 1.2 现有功能分析

#### 当前登录流程 (auth.service.ts:login)
1. 验证必填字段（phone/account + password/code）
2. 查找用户（通过phone或account）
3. 如果用户不存在且使用验证码，则调用register方法
4. 如果用户不存在且使用密码，抛出"账号不存在"错误
5. 如果用户存在，验证密码或验证码
6. 更新登录信息（lastLoginAt, lastLoginIp）
7. 生成JWT Token
8. 存储Token到数据库和Redis缓存
9. 返回用户信息和Token

#### 当前注册流程 (auth.service.ts:register)
1. 验证验证码（如果使用验证码注册）
2. 解密密码（RSA）
3. 哈希密码（Scrypt）
4. 生成唯一账号（6位随机数）
5. 创建用户记录（包含基础信息）
6. 初始化论坛资料
7. 生成Token
8. 返回用户信息和Token

### 1.3 业务域和数据模型

#### AppUser核心字段
- account: 唯一账号（6位数字）
- nickname: 用户昵称（默认：用户{account}）
- password: 加密密码
- phone: 手机号（唯一）
- email: 邮箱（唯一）
- isEnabled: 账户状态
- gender: 性别（默认：未知）
- lastLoginAt: 最后登录时间
- lastLoginIp: 最后登录IP

#### 安全相关
- RSA加密：用于传输层加密密码
- Scrypt哈希：用于存储层密码加密
- JWT Token：用于会话管理
- 设备管理：支持多设备登录和撤销

## 2. 原始需求

### 2.1 登录方式支持
1. 手机号+验证码登录
2. 账号或手机号+密码登录

### 2.2 手机号验证码登录流程
1. 用户输入手机号并获取验证码
2. 验证验证码有效性
3. 若用户不存在，自动执行注册流程：
   - 创建新用户记录
   - 填充基础默认值（包括但不限于必要的用户信息字段）
   - 生成随机密码并安全存储
4. 验证通过后完成登录并返回用户认证信息

### 2.3 账号密码登录流程
1. 用户输入账号和密码
2. 验证账号是否存在
3. 若账号不存在，直接返回"账号不存在"的明确提示
4. 若账号存在，验证密码正确性并完成登录

### 2.4 安全要求
1. 随机密码需符合安全复杂度要求
2. 密码存储必须采用系统的rsa加密

### 2.5 错误处理
1. 提供清晰的错误提示信息
2. 对异常情况进行适当处理和反馈

## 3. 边界确认

### 3.1 任务范围
- **包含**: 
  - 优化登录接口，支持手机号验证码登录和账号密码登录
  - 实现手机号验证码登录时的自动注册功能
  - 生成安全的随机密码
  - 完善错误处理和提示信息
- **不包含**:
  - 修改注册接口（保持现有注册接口不变）
  - 修改忘记密码和重置密码功能
  - 修改Token管理机制
  - 修改设备管理功能

### 3.2 技术约束
- 必须使用现有的RSA和Scrypt加密机制
- 必须使用现有的SmsService发送和验证验证码
- 必须使用现有的BaseAuthService生成JWT Token
- 必须使用现有的AppTokenStorageService管理Token
- 必须遵循现有的代码规范和架构模式

### 3.3 集成方案
- 修改AuthService.login方法，优化登录逻辑
- 修改AuthService.register方法，支持自动生成随机密码
- 新增生成随机密码的辅助方法
- 更新错误常量，添加新的错误提示

## 4. 需求理解

### 4.1 对现有项目的理解
1. **现有登录逻辑问题**:
   - 当前login方法中，验证码登录时调用了register方法，但register方法要求传入password字段
   - 手机号验证码登录时，用户未设置密码，但register方法需要password
   - 验证码登录成功后，未更新用户的lastLoginAt和lastLoginIp

2. **需要优化的点**:
   - 手机号验证码登录时，如果用户不存在，应该自动注册并生成随机密码
   - 账号密码登录时，如果账号不存在，应该明确提示"账号不存在"
   - 手机号验证码登录成功后，需要更新登录信息
   - 随机密码需要符合安全复杂度要求

### 4.2 需求理解
1. **手机号验证码登录**:
   - 输入：phone + code
   - 流程：验证验证码 → 查找用户 → 如果不存在则自动注册（生成随机密码）→ 登录
   - 输出：用户信息 + Token

2. **账号密码登录**:
   - 输入：account + password 或 phone + password
   - 流程：查找用户 → 如果不存在则报错 → 验证密码 → 登录
   - 输出：用户信息 + Token

3. **随机密码生成**:
   - 长度：至少12位
   - 复杂度：包含大小写字母、数字、特殊字符
   - 存储：使用RSA加密 + Scrypt哈希

## 5. 疑问澄清

### 5.1 需要确认的问题

1. **随机密码复杂度要求**:
   - 密码长度：建议12-16位
   - 字符类型：大小写字母 + 数字 + 特殊字符
   - 特殊字符范围：!@#$%^&*()_+-=[]{}|;:,.<>?

2. **自动注册的默认值**:
   - nickname: 用户{account}（现有逻辑）
   - gender: GenderEnum.UNKNOWN（现有逻辑）
   - isEnabled: true（现有逻辑）
   - 其他字段：是否需要设置默认值？

3. **验证码登录后的Token生成**:
   - 是否需要和密码登录使用相同的Token生成逻辑？
   - 是否需要存储设备信息？

4. **错误提示**:
   - 验证码错误：是否需要区分"验证码错误"和"验证码已过期"？
   - 账号不存在：是否需要区分"账号不存在"和"手机号不存在"？

### 5.2 智能决策

基于现有代码和行业最佳实践，我做出以下决策：

1. **随机密码复杂度**:
   - 长度：16位
   - 字符类型：大写字母(2) + 小写字母(2) + 数字(2) + 特殊字符(2) + 随机字符(8)
   - 特殊字符：!@#$%^&*

2. **自动注册默认值**:
   - 保持现有逻辑：nickname = 用户{account}, gender = UNKNOWN, isEnabled = true
   - 不设置其他字段的默认值

3. **Token生成**:
   - 使用相同的Token生成逻辑
   - 存储设备信息（与现有逻辑一致）

4. **错误提示**:
   - 验证码错误：统一提示"验证码错误或已过期"
   - 账号不存在：统一提示"账号不存在"

## 6. 项目特性规范

### 6.1 代码规范
- 使用TypeScript严格模式
- 使用class-validator进行数据验证
- 使用class-transformer进行数据转换
- 使用装饰器进行路由配置和文档生成
- 错误信息集中管理在constant文件

### 6.2 安全规范
- 密码传输必须使用RSA加密
- 密码存储必须使用Scrypt哈希
- 敏感信息不得在日志中输出
- 使用常量时间比较防止时序攻击

### 6.3 测试规范
- 单元测试覆盖率要求：>80%
- 集成测试覆盖主要业务流程
- 测试数据使用seed脚本生成

### 6.4 文档规范
- API文档使用Swagger自动生成
- 代码注释使用JSDoc格式
- 复杂逻辑需要添加行内注释
