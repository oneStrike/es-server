# 注释规范方案（草案）

## 1. 范围与边界

- **覆盖范围**：除 controller / dto / module 文件之外的所有源码文件（apps、libs、prisma）。包括常量、枚举、类型定义、工具类、服务、仓储、prisma 相关逻辑与模型。
- **排除范围**：生成代码（如 prismaClient 目录）与三方依赖文件。
- **语言要求**：注释统一使用中文。

## 2. 现状快速排查摘要

- **常量/枚举注释不一致**：部分常量/枚举缺少说明或仅有文件级标题，语义难以直接理解。
  - 示例：基础枚举无任何说明 [base.constant.ts:L1-L44](file:///d:/code/es/es-server/libs/base/src/constant/base.constant.ts#L1-L44)
  - 示例：枚举值缺少语义描述 [user.constant.ts:L11-L17](file:///d:/code/es/es-server/libs/base/src/constant/user.constant.ts#L11-L17)
  - 示例：核心业务常量缺少用途说明 [growth-event.constant.ts:L1-L4](file:///d:/code/es/es-server/libs/user/src/growth-event/growth-event.constant.ts#L1-L4)
- **类型注释表现不一**：部分接口存在行内注释，部分类型缺少用途说明。
  - 示例：接口字段逐项注释齐全 [base.module.types.ts:L1-L17](file:///d:/code/es/es-server/libs/base/src/base.module.types.ts#L1-L17)
- **Prisma 模型注释较好**：模型与字段说明完整，存在分段说明与枚举含义。
  - 示例：模型与字段注释清晰 [forum-config.prisma:L1-L95](file:///d:/code/es/es-server/prisma/models/forum/forum-config.prisma#L1-L95)

## 3. 注释目标

- **可读性**：业务语义对新成员清晰可理解。
- **可维护性**：常量/枚举/类型/Prisma 操作的意图、边界、默认值明确。
- **一致性**：统一的注释位置、格式、密度与口径。

## 4. 核心规范

### 4.1 注释类型与使用位置

- **文件级注释**：说明该文件的职责与核心概念（适用于 constant、service、util、type）。
- **导出对象注释**：对 export const / enum / type / interface / class 给出用途说明。
- **字段/成员注释**：枚举值、常量键、interface 属性、Prisma 模型字段必须有语义注释。
- **行为注释**：包含副作用、边界条件、幂等、事务等的逻辑必须有行内说明。

### 4.2 常量与枚举

- **文件级**：一句话描述该文件定义的“业务域”与“用途”。
- **枚举**：枚举本身 + 每个枚举值必须有注释。
- **常量对象**：对象级说明 + 每个键说明含义、单位或约束。
- **命名约定**：
  - 枚举：`XxxEnum`
  - 常量对象：`XxxMap` 或 `XxxConfig`
  - 事件/路由/Key：`XxxKey`，且注释说明完整路径语义。

### 4.3 类型与接口

- **接口/类型别名**：必须说明“该类型代表的业务含义”与“使用场景”。
- **字段级**：每个字段必须说明含义、单位、是否可空、默认行为。
- **泛型**：说明泛型参数含义与约束。

### 4.4 Prisma 相关操作

- **模型（schema / models）**：模型级一句话概览 + 字段级说明 + 索引说明。
- **Service/Repository 中 Prisma 调用**：
  - 必须标注“本次查询/写入的业务目的”。
  - 事务范围需要说明“为何使用事务”和“事务边界”。
  - 软删除、幂等、缓存一致性必须说明处理策略。

### 4.5 不建议的注释

- 只复述代码字面含义的注释。
- 对显而易见的语法结构添加描述。
- 与实际逻辑不一致或过期的注释。

## 5. 标准化模板

### 5.1 常量文件模板

```ts
/**
 * <模块> 常量定义
 * 用途：<一句话说明用途>
 */

/// <枚举名称>（<用途描述>）
export enum XxxEnum {
  /** <值含义> */
  A = 1,
}

/// <常量对象用途>
export const XxxMap = {
  /** <键含义/单位/约束> */
  A: 'a',
}
```

### 5.2 类型定义模板

```ts
/**
 * <类型名称>：<业务含义>
 * 使用场景：<出现的模块/流程>
 */
export interface Xxx {
  /** <字段含义/单位/约束> */
  field: string
}
```

### 5.3 Prisma 操作模板

```ts
/**
 * <操作目的>
 * 关键说明：<幂等/事务/缓存/副作用>
 */
await this.prisma.xxx.update({ ... })
```

## 6. 质量门禁与验收标准

- 常量/枚举/类型/Prisma 模型与操作均有明确注释。
- 任何带有数值含义的枚举值必须说明语义。
- 任何带有单位/范围/默认值的字段必须说明。
- 任何事务/批量/幂等/缓存写入必须说明策略。

## 7. 改造实施建议（待确认后执行）

1. **梳理清单**：输出“缺失注释清单”，按模块与文件归类。
2. **分层修复**：先修复常量/枚举/类型，再修复 Prisma 操作注释。
3. **统一口径**：引入上述模板并统一文件级、导出级、字段级格式。
4. **验收检查**：按门禁清单逐文件核验与复查。
