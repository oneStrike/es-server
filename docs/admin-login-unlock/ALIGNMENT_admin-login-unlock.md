# 阶段 1: Align（对齐阶段）

## 原始需求

- 登录模块目前仅在失败次数过多时锁定账号，没有自动解锁机制。
- 期望半小时后再次登录时，若锁定已过期，应自动解锁并允许继续登录。

## 项目与任务特性规范

- 技术栈：NestJS + Prisma + Fastify。
- 相关模块：`AdminAuthService`（登录逻辑）、`RequestLogService`（审计日志）、`AdminUser`（Prisma 模型）。
- 现有字段：`isLocked`、`loginFailAt`、`loginFailCount`、`loginFailIp`。
- 现状：达到 5 次失败后锁定（硬编码），无解锁机制。

## 需求边界确认

- 范围仅限管理端登录逻辑（`/api/admin/login`）。
- 自动解锁基于时间窗口（默认 30 分钟），由配置驱动。
- 不涉及客户端登录或前端 UI 改造。
- 不新增数据库字段，仅复用现有字段。

## 需求理解

- 登录前若用户处于锁定状态，需要判断是否已超过锁定时长；若超过则重置锁定并继续登录流程，否则拒绝。
- 登录失败逻辑保持不变：递增失败计数，超过阈值锁定。
- 阈值与锁定时长需要可配置（环境变量）。

## 疑问澄清（结构化问题清单）

1. 锁定期间的再次尝试是否继续累加失败计数？（当前实现：会累加；可作为后续优化选项）
2. 是否需要在用户信息接口返回锁定剩余时间？（当前不需要）
3. 是否需要支持不同角色不同策略？（当前不需要）

## 智能决策策略与回答

- 阈值与时长使用环境变量配置，默认：失败 5 次锁定，锁定 30 分钟。
- 自动解锁在服务端登录流程内判断并重置状态，不改动数据库结构。
- 维持现有审计日志规则：锁定状态下仍记录失败日志。
