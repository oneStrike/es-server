# ES-Server 项目鉴权方案说明文档
## 1. 概述

ES-Server 项目采用了基于 JWT (JSON Web Token) 的现代化鉴权方案，结合 NestJS 框架的守卫机制和 Passport 认证库，实现了安全、灵活的身份验证和授权管理。

## 2. 技术栈与架构

### 2.1 核心技术组件

- **NestJS**: 主框架，提供依赖注入和模块化架构
- **Passport.js**: 认证中间件，支持多种策略
- **JWT (JSON Web Token)**: 无状态令牌机制
- **Redis**: 令牌黑名单缓存存储
- **TypeScript**: 类型安全的实现

### 2.2 架构层次

```
┌─────────────────┐
│   HTTP Request  │
└─────────────────┘
         ↓
┌─────────────────┐
│   JwtAuthGuard  │ ←── Public Decorator (可选跳过)
└─────────────────┘
         ↓
┌─────────────────┐
│  AuthStrategy   │ ←── Passport JWT Strategy
└─────────────────┘
         ↓
┌─────────────────┐
│  JWT Validation │ ←── Token解码、签名验证、黑名单检查
└─────────────────┘
         ↓
┌─────────────────┐
│  User Context   │ ←── request.user 对象设置
└─────────────────┘
```

## 3. 核心组件详解

### 3.1 JwtAuthGuard (JWT认证守卫)

**位置**: `apps/admin-api/src/guards/auth.guard.ts`

**功能**:
- 继承自 `@nestjs/passport` 的 `AuthGuard`
- 全局应用，自动拦截所有HTTP请求
- 支持通过 `@Public()` 装饰器跳过认证
- 统一的错误处理和用户信息提取

**关键特性**:
```typescript
// 公共路由标记
@Public()
@Get('login')
async login() { ... }

// 守卫逻辑
async canActivate(context: ExecutionContext) {
  // 检查是否为公共路由
  const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
    context.getHandler(),
    context.getClass(),
  ])
  
  if (isPublic) {
    return true // 跳过认证
  }
  
  return (await super.canActivate(context)) as boolean
}
```

### 3.2 AuthStrategy (认证策略)

**位置**: `libs/auth/src/auth.strategy.ts`

**功能**:
- 继承自 `PassportStrategy(Strategy)`
- 实现 JWT 令牌的解码和验证
- 黑名单检查机制
- Audience (aud) 验证

**验证流程**:
1. JWT 签名验证
2. 过期时间检查
3. Audience 匹配验证
4. 黑名单状态检查
5. 返回用户信息

### 3.3 BaseAuthModule (认证模块)

**位置**: `libs/auth/src/auth.module.ts`

**配置**:
- 异步配置 Passport 策略
- JWT 模块注册和配置
- 服务提供者注册
- 全局模块导出

**依赖注入**:
```typescript
@Global()
@Module({
  imports: [
    PassportModule.registerAsync({ /* 配置 */ }),
    NestjsJwtModule.registerAsync({ /* 配置 */ }),
  ],
  providers: [AuthService, JwtBlacklistService, AuthStrategy],
  exports: [AuthService, JwtBlacklistService],
})
```

### 3.4 AuthService (认证服务)

**位置**: `libs/auth/src/auth.service.ts`

**核心功能**:
- 令牌生成 (access token + refresh token)
- 令牌刷新机制
- 登出和令牌黑名单管理
- 令牌有效期计算

**令牌生成**:
```typescript
async generateTokens(payload) {
  payload = {
    ...payload,
    jti: uuid(), // JWT ID
    aud: this.config.aud, // Audience
  }

  const [accessToken, refreshToken] = await Promise.all([
    this.jwtService.signAsync(
      { ...payload, type: 'access' },
      { secret: this.config.secret, expiresIn: this.config.expiresIn }
    ),
    this.jwtService.signAsync(
      { ...payload, type: 'refresh' },
      { secret: this.config.refreshSecret, expiresIn: this.config.refreshExpiresIn }
    ),
  ])

  return { accessToken, refreshToken }
}
```

### 3.5 JwtBlacklistService (黑名单服务)

**位置**: `libs/auth/src/jwt-blacklist.service.ts`

**功能**:
- 基于 Redis 的令牌黑名单管理
- 支持令牌的添加、查询和删除
- 自动过期机制

**实现机制**:
```typescript
// 添加黑名单
async addBlacklist(jti: string, expiresIn: number): Promise<void> {
  await this.cacheManager.set(this.BLACKLIST_PREFIX + jti, true, expiresIn)
}

// 检查黑名单
async isInBlacklist(jti: string): Promise<boolean> {
  const result = await this.cacheManager.get(this.BLACKLIST_PREFIX + jti)
  return result === true
}
```

## 4. 配置管理

### 4.1 JWT 配置 (`apps/admin-api/src/config/jwt.config.ts`)

```typescript
export const AuthConfig = {
  secret: process.env.JWT_SECRET,                    // 访问令牌密钥
  refreshSecret: process.env.JWT_REFRESH_SECRET,    // 刷新令牌密钥
  expiresIn: 4 * TIME_CONSTANTS.HOUR,               // 访问令牌过期时间 (4小时)
  refreshExpiresIn: 7 * TIME_CONSTANTS.DAY,         // 刷新令牌过期时间 (7天)
  aud: 'admin',                                     // 令牌受众
  strategyKey: 'admin-auth',                        // Passport策略键
}
```

### 4.2 环境变量配置

```env
# JWT 配置
JWT_SECRET="c1312df24cc974b7c885f539c59be2e3091c24957e0f6c32b0f2ed799a138bc6"
JWT_REFRESH_SECRET="2c5aa7185a79cdab738d446d125136367c866c71f8c5e87d92433e42cfbe2ca5"
```

## 5. 装饰器系统

### 5.1 @Public() 装饰器

**位置**: `libs/decorators/src/public.decorator.ts`

**用途**: 标记公共路由，跳过 JWT 认证

**使用示例**:
```typescript
@Public()
@Post('login')
async login(@Body() body: UserLoginDto) {
  // 登录接口，无需认证
}

@Public()
@Get('captcha')
async getCaptcha() {
  // 获取验证码，无需认证
}
```

### 5.2 @CurrentUser() 装饰器

**位置**: `libs/decorators/src/current-user.decorator.ts`

**用途**: 从请求中提取当前用户信息

**使用示例**:
```typescript
@Post('update-info')
async updateUserInfo(
  @Body() body: UpdateUserDto,
  @CurrentUser() user
) {
  // user 对象包含 JWT payload 信息
  return this.userService.updateUserInfo(Number.parseInt(user.sub), body)
}
```

## 6. 认证流程

### 6.1 登录流程

```
1. 用户请求登录 (POST /admin/auth/login)
2. 验证用户名和密码 (RSA解密 + scrypt验证)
3. 检查账户状态 (锁定、启用状态)
4. 生成 JWT 令牌对 (access + refresh)
5. 返回用户信息和令牌
```

### 6.2 请求认证流程

```
1. HTTP 请求到达
2. JwtAuthGuard 拦截
3. 检查是否为公共路由 (@Public)
4. 提取 Authorization: Bearer <token>
5. AuthStrategy 验证 JWT
6. 检查黑名单状态
7. 设置 request.user
8. 继续处理请求
```

### 6.3 令牌刷新流程

```
1. 客户端发送 refresh token (POST /admin/auth/refresh-token)
2. 验证 refresh token 有效性
3. 检查黑名单状态
4. 将旧 refresh token 加入黑名单
5. 生成新的令牌对
6. 返回新令牌
```

### 6.4 登出流程

```
1. 客户端发送登出请求 (POST /admin/auth/logout)
2. 提取 access token 和 refresh token
3. 将两个令牌都加入黑名单
4. 返回成功状态
```

## 7. 安全特性

### 7.1 密码安全
- 使用 RSA 加密传输密码
- 使用 scrypt 算法存储密码哈希
- 登录失败次数限制和账户锁定机制

### 7.2 令牌安全
- 双令牌机制 (access + refresh)
- 令牌黑名单机制
- 短期访问令牌 (4小时)
- 长期刷新令牌 (7天)
- JWT ID (jti) 唯一标识

### 7.3 传输安全
- HTTPS 推荐
- Bearer Token 传输
- 敏感信息加密传输

## 8. 用户角色与权限

### 8.1 管理员用户 (AdminUser)

**数据模型**: `prisma/models/admin/admin-user.prisma`

**角色定义**:
- `role: 0` - 普通管理员
- `role: 1` - 超级管理员

**安全字段**:
- `isEnabled`: 账户启用状态
- `isLocked`: 账户锁定状态
- `loginFailCount`: 登录失败次数
- `loginFailAt`: 最后失败时间

### 8.2 客户端用户 (ClientUser)

**数据模型**: `prisma/models/client/client-user.prisma`

**特性**:
- 支持软删除 (`deletedAt`)
- 多因素标识 (用户名、手机号、邮箱)
- 性别类型枚举

## 9. 错误处理

### 9.1 统一错误消息
```typescript
private static readonly UNAUTHORIZED_MESSAGE = '登录失效，请重新登录！'
```

### 9.2 错误类型
- `UnauthorizedException`: 认证失败
- `BadRequestException`: 请求参数错误
- `NotFoundException`: 用户不存在

## 10. 监控与日志

### 10.1 关键日志点
- 登录成功/失败记录
- 账户锁定/解锁事件
- 令牌操作记录
- 安全事件审计

### 10.2 性能监控
- 认证响应时间
- 令牌验证性能
- Redis 缓存命中率

## 11. 扩展性设计

### 11.1 模块化架构
- 独立的 `BaseAuthModule` 库
- 可复用的认证组件
- 清晰的接口定义

### 11.2 配置驱动
- 环境变量配置
- 异步配置加载
- 灵活的配置选项

### 11.3 策略模式
- Passport 策略可扩展
- 支持多种认证方式
- 易于添加新的验证逻辑

## 12. 最佳实践

### 12.1 开发规范
- 公共接口使用 `@Public()` 装饰器明确标记
- 用户信息获取使用 `@CurrentUser()` 装饰器
- 敏感操作记录审计日志

### 12.2 安全建议
- 定期更换 JWT 密钥
- 监控异常登录行为
- 实施最小权限原则
- 定期清理过期令牌

### 12.3 性能优化
- 合理使用缓存
- 优化数据库查询
- 异步处理耗时操作
