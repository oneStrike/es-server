# ALIGNMENT - 论坛板块扁平化改造

## 项目特性规范

### 技术栈
- **框架**: NestJS 11.x
- **语言**: TypeScript 5.x
- **数据库**: PostgreSQL
- **ORM**: Prisma 7.x
- **缓存**: Redis (Keyv)
- **API 文档**: Swagger
- **验证**: class-validator
- **开发工具**: ESLint, Prettier, Husky

### 项目结构
- Monorepo 架构，包含 `apps` 和 `libs` 两个主要目录
- `apps/admin-api`: 管理后台 API
- `apps/client-api`: 客户端 API
- `libs/forum`: 论坛模块共享库
- `libs/base`: 基础库（数据库、工具类等）

### 代码规范
- 使用 Conventional Commits 提交规范
- ESLint + Prettier 代码质量检查
- TypeScript 严格类型检查
- 遵循 NestJS 最佳实践
- 使用装饰器进行验证和文档

## 原始需求

用户希望将论坛板块功能从两级层级结构改造为：
1. **去掉层级**：只支持一级板块
2. **增加板块分组**：引入板块分组功能
3. **支持排序**：板块和分组都支持排序
4. **不需要权限**：分组不需要权限控制
5. **允许板块不分组**：板块可以不属于任何分组
6. **需要迁移**：需要数据迁移方案

## 边界确认

### 任务范围
- ✅ 修改 `ForumSection` 模型，去掉层级相关字段
- ✅ 创建 `ForumSectionGroup` 模型
- ✅ 修改相关的 DTO 和 Service
- ✅ 创建数据迁移脚本
- ✅ 更新 seed 数据
- ❌ 不涉及前端界面改动
- ❌ 不涉及其他模块的板块相关功能（如权限、审核等）

### 不在范围内
- 前端界面适配
- 其他模块的板块相关功能修改
- 性能优化（除非必要）

## 需求理解

### 现有架构分析

**当前两级层级结构：**
```
ForumSection 模型包含：
- parentId: 父板块ID（支持多级子版块）
- level: 板块层级深度（0为主板块，1为一级子版块）
- path: 板块路径（如：/1/3/ 表示归属于板块1下的板块3）
- inheritPermission: 是否继承父板块权限
- parent/children: 自关联关系

示例结构：
技术交流（level=0）
  ├── 前端开发（level=1）
  ├── 后端开发（level=1）
  └── 数据库（level=1）
经验分享（level=0）
问答专区（level=0）
```

**问题：**
1. 层级关系增加了复杂度（需要维护 parentId、level、path）
2. 权限继承逻辑复杂
3. 统计数据需要递归计算子板块
4. 实际上很多论坛已经扁平化，不再使用多级结构

### 业务逻辑理解

**新的扁平化+分组结构：**
```
ForumSectionGroup（板块分组）
  - id: 主键
  - name: 分组名称
  - description: 分组描述
  - sortOrder: 排序权重
  - isEnabled: 是否启用
  - icon: 分组图标
  - sections: 关联的板块列表

ForumSection（板块）
  - id: 主键
  - name: 板块名称
  - groupId: 所属分组ID（可选）
  - icon: 板块图标
  - sortOrder: 排序权重
  - isEnabled: 是否启用
  - topicReviewPolicy: 主题审核策略
  - userLevelRuleId: 用户等级规则ID
  - topicCount: 主题数
  - replyCount: 回复数
  - lastPostAt: 最后发表时间
  - lastTopicId: 最后发表主题ID
  - description: 板块描述
  - remark: 备注信息
  - createdAt: 创建时间
  - updatedAt: 更新时间
  - deletedAt: 软删除时间

示例结构：
分组：技术交流组
  ├── 前端开发
  ├── 后端开发
  └── 数据库
分组：经验分享组
  └── 经验分享
分组：问答组
  └── 问答专区
分组：活动组
  └── 活动公告
分组：反馈组
  └── 建议反馈
```

**优点：**
1. 板块结构扁平，查询简单
2. 分组更灵活，可以按业务维度组织
3. 权限管理更清晰，不需要继承逻辑
4. 统计逻辑简化
5. 更符合现代论坛设计趋势

## 疑问澄清

### 已确认的需求
1. ✅ 支持排序：板块和分组都支持排序（sortOrder 字段）
2. ✅ 不需要权限：分组不需要权限控制
3. ✅ 允许板块不分组：groupId 字段为可选（nullable）
4. ✅ 需要迁移：需要将现有的层级数据迁移到新的分组结构

### 需要确认的问题
1. **分组排序范围**：分组是在全局范围内排序，还是在某个父级下排序？
   - 理解：全局排序，因为分组本身没有层级

2. **板块排序范围**：板块是在分组内排序，还是在全局范围内排序？
   - 理解：在分组内排序，因为分组已经提供了组织结构

3. **数据迁移策略**：现有的主板块和子板块如何映射到新的分组结构？
   - 理解：将现有的主板块（level=0）转换为分组，子板块（level=1）转换为该分组下的板块

4. **统计数据处理**：现有的 topicCount 和 replyCount 是否需要重新计算？
   - 理解：不需要，因为统计逻辑会简化，直接使用现有数据

5. **权限处理**：现有的 inheritPermission 字段删除后，权限如何处理？
   - 理解：板块权限直接关联，不再继承

6. **板块移动功能**：是否需要支持板块在不同分组之间移动？
   - 理解：需要，通过修改 groupId 字段实现

7. **分组删除**：删除分组时，关联的板块如何处理？
   - 理解：将板块的 groupId 设置为 null，即变为未分组状态

8. **板块查询**：是否需要支持按分组查询板块？
   - 理解：需要，这是分组的主要用途

### 智能决策

基于对现有代码的分析和行业最佳实践，我做出以下决策：

1. **分组排序**：全局排序，因为分组本身没有层级
2. **板块排序**：在分组内排序，因为分组已经提供了组织结构
3. **数据迁移策略**：
   - 将现有的主板块（level=0）转换为分组
   - 将现有的子板块（level=1）转换为该分组下的板块
   - 保留原有的排序权重
   - 保留原有的统计数据
4. **权限处理**：删除 inheritPermission 字段，板块权限直接关联
5. **板块移动**：支持通过修改 groupId 字段实现
6. **分组删除**：将板块的 groupId 设置为 null
7. **板块查询**：支持按分组查询板块

## 技术约束

### 数据库约束
- 使用 PostgreSQL
- 使用 Prisma ORM
- 需要创建数据库迁移脚本
- 需要更新 seed 数据

### 代码约束
- 遵循现有的代码规范
- 使用现有的工具和库
- 保持与现有代码风格一致
- 复用现有组件和模式

### 性能约束
- 查询性能不能降低
- 需要添加适当的索引
- 避免N+1查询问题

## 验收标准

### 功能验收
- ✅ 板块分组功能正常工作
- ✅ 板块可以属于或不属于分组
- ✅ 板块和分组都支持排序
- ✅ 现有数据成功迁移
- ✅ 板块查询功能正常
- ✅ 板块CRUD操作正常

### 性能验收
- ✅ 查询性能不低于改造前
- ✅ 数据库索引合理
- ✅ 避免N+1查询

### 代码质量验收
- ✅ 代码符合项目规范
- ✅ TypeScript 类型检查通过
- ✅ ESLint 检查通过
- ✅ 测试覆盖核心功能

## 风险评估

### 技术风险
- **数据迁移风险**：现有数据可能无法完美映射到新结构
  - 缓解措施：创建详细的迁移脚本，并在测试环境验证

- **性能风险**：新的查询结构可能影响性能
  - 缓解措施：添加适当的索引，优化查询逻辑

- **兼容性风险**：现有API可能需要调整
  - 缓解措施：保持API接口不变，只修改内部实现

### 业务风险
- **用户体验风险**：前端界面可能需要调整
  - 缓解措施：保持API接口不变，前端可以逐步适配

## 后续计划

1. 创建 CONSENSUS 文档，确认最终共识
2. 创建 DESIGN 文档，设计新架构
3. 创建 TASK 文档，拆分子任务
4. 执行实施
5. 验收测试
6. 生成 FINAL 文档
