## 用户成长体系重构（User Growth Refactor）- CONSENSUS（单体严格版）

> 前提：不拆分微服务；重构现有 `libs/user` 为“用户成长域”库；  
> 命名采用 `growth` 目录 + `UserGrowthModule` 聚合模块；  
> 本轮引入独立事件审计表，成长规则保持各子域自配置，防刷策略按严格标准执行。

### 1. 总体目标与约束

- 建立统一的“用户成长域（User Growth Domain）”，承载：
  - 积分（Points）
  - 经验（Experience）
  - 等级及等级权益（Level & Privileges）
  - 通用用户徽章（Badges）
  - 成长事件审计（GrowthEvent Audit）
- 业务域（论坛、漫画等）通过**领域事件**驱动成长，不直接操作积分/经验/徽章服务。
- 系统形态：
  - 继续采用**单体 NestJS 应用 + libs 模块化**；
  - 不为后续微服务拆分刻意预留复杂基础设施，仅保持合理的领域边界。
- 风险控制：
  - 本轮必须引入**独立事件审计表**，记录关键成长事件；
  - 防刷策略按“严格”标准设计并落地；
  - 成长规则在本轮保持各子域自配置，不做统一规则中心。

---

### 2. 目标架构（单体 + 成长域模块）

#### 2.1 模块划分

- `libs/user/src/growth`（用户成长域主目录）
  - `growth.module.ts`：`UserGrowthModule` 聚合模块，对外唯一入口。
  - `events/`：成长事件模型与分发入口。
  - `points/`：积分子域。
  - `experience/`：经验子域。
  - `level/`：等级与等级权益子域。
  - `badge/`：通用用户徽章子域。
  - `audit/`：事件审计表访问层。
  - `antifraud/`：防刷策略与限流控制。

- 业务域库
  - `libs/forum/*`：论坛域，仅作为成长事件的**生产者**；
  - `libs/comic/*`：漫画域，同样作为成长事件生产者；
  - 后续其他业务域（如任务系统、活动系统）可按相同方式接入。

#### 2.2 调用与数据流（时序概览）

1. 业务域完成核心业务操作（例如用户成功发帖、成功阅读章节）。
2. 业务域构造 `GrowthEvent`（领域事件 DTO），并调用 `UserGrowthModule` 暴露的事件入口：
   - `userGrowthService.handleEvent(event: GrowthEventDto)`。
3. 成长域内部流程：
   - 通过 `antifraud` 模块执行严格防刷校验（用户/IP/设备/频次等）；
   - 将事件写入审计表（`user_growth_event`），用于后续查询和排查；
- 由对应子域根据自身规则表匹配并执行（积分变更、经验变更、徽章发放、等级变更）；
   - 子域在各自的记录表中追加明细记录（PointRecord、ExperienceRecord、UserBadgeAssignment 等）。

> 说明：这里不再引入跨进程消息队列或微服务事件总线；所有事件处理在单体内同步（或可控异步）完成，重点在于领域边界、规则统一与审计、防刷。

---

### 3. 核心模型设计

#### 3.1 成长事件（GrowthEvent）

- DTO 字段建议：
  - `id`：事件唯一 ID（由成长域生成或业务域传入，可选）。
  - `business`：业务域标识，如 `forum`、`comic`。
  - `eventKey`：事件键，如 `forum.topic.create`、`forum.reply.create`、`comic.chapter.read`。
  - `userId`：受影响的用户 ID。
  - `targetId`：业务目标 ID（如主题 ID、章节 ID），可选。
  - `ip`：请求 IP，用于防刷。
  - `deviceId`：设备标识（如有），用于防刷。
  - `occurredAt`：事件发生时间（UTC）。
  - `context`：JSON/Map，存放扩展字段（如来源渠道、客户端类型等）。

#### 3.2 事件审计表（UserGrowthEvent）

- 目的：记录所有经过成长域处理的关键事件，用于：
  - 排查用户成长异常；
  - 追踪防刷触发情况；
  - 运营回看历史行为。
- 建议字段：
  - `id`：主键。
  - `business`、`eventKey`、`userId`、`targetId`、`ip`、`deviceId`、`occurredAt`、`context`。
  - `status`：处理状态（如 `PROCESSED`、`REJECTED_ANTIFRAUD`、`IGNORED_RULE_NOT_FOUND` 等）。
  - `ruleRefs`：命中的规则引用（子域类型 + 规则 ID 列表）。
  - `pointsDeltaApplied`、`experienceDeltaApplied`、`badgeAssigned`（概要信息，方便查询）。
  - `createdAt` / `updatedAt`。

> 本轮审计表主要用于查询与审计，不要求实现完整的事件重放机制。

#### 3.3 子域模型（概览）

- 积分（Points）
  - `PointRecord`：记录每次积分变动（来源事件、变动值、余额等）。
- 经验（Experience）
  - `ExperienceRecord`：记录每次经验变动，并支持按用户聚合。
- 等级（Level）
  - `LevelRule`：等级区间与成长值阈值；
  - 用户等级字段仍挂在 `AppUser`（如 `levelId` 或 `level`）。
- 徽章（Badges）
  - `UserBadge`：徽章定义；
  - `UserBadgeAssignment`：用户-徽章关联记录。

---

### 4. 防刷策略（严格且可配置）

防刷模块（`antifraud`）在每次事件处理前执行检验，**所有关键阈值通过配置持久化管理**，不写死在代码里。严格策略包含：

1. **用户维度限频（可配置）**
   - 对每个 `userId + eventKey`，维护短时间窗口及每日窗口的计数；
  - `cooldownSeconds`、`dailyLimit`、`totalLimit` 等参数由各子域规则表或专门的防刷配置表提供；
   - 超过冷却窗口重复触发，则标记为“冷却中”，拒绝本次成长；
   - 超过 `dailyLimit` / `totalLimit` 时，规则不再对该用户生效。

2. **IP / 设备维度限频（可配置）**
   - 对每个 `ip + eventKey`、`deviceId + eventKey` 统计频次；
   - 各类阈值同样通过配置管理（可按 eventKey 设定不同规则）；
   - 当短时间内同一 IP/设备触发事件过于密集时，可直接拒绝或进入降级逻辑，并在审计表中记录原因。

3. **高价值事件特殊处理（配置驱动）**
   - 高价值事件的判定规则（如积分/经验阈值、特定徽章）通过配置维护；
   - 对被判定为高价值的事件，自动套用更严格的防刷参数：
     - 更长的冷却时间；
     - 更低的 `dailyLimit` / `totalLimit`；
     - 可选的人工审核标记位（例如需要运营审核后才最终生效）。

4. **默认策略（严格）建议**
   - 系统提供一套“严格默认值”作为初始配置（例如发帖事件的冷却时间与每日上限），可在管理端调整；
   - 对刷行为敏感的事件（如短时间大量发帖），默认启用 IP/设备维度限频；
   - 在审计表中记录每次防刷命中的配置版本与原因，方便运营排查和日后调整。

> 底层实现可以基于缓存（如 Redis）或数据库计数；本方案要求核心参数可通过配置持久化与管理端界面进行调整，以支持在“严格”的前提下按业务需求动态微调。

---

### 5. 里程碑与实施路径

#### M1：重构 `libs/user` 为用户成长域库

- 在 `libs/user/src` 下建立 `growth` 目录与 `UserGrowthModule`：
  - 初步迁移现有积分/经验/等级服务到对应子目录；
  - 保持对外接口尽量兼容现有使用方式（暂不替换调用方）。
#### M2：引入 GrowthEvent 模型与严格防刷骨架

- 定义 `GrowthEventDto`、事件处理入口 `handleEvent`；
- 引入 `antifraud` 模块，实现：
  - 用户维度限频；
  - 基本 IP/设备维度限频（至少支持 IP 维度）。
- 引入事件审计表 `user_growth_event`：
  - 落地事件基本字段；
  - 记录处理状态与命中规则概要。

#### M3：子域规则事件化适配

- 保持 `AppPointRule` / `AppExperienceRule` / `AppLevelRule` 等各子域规则表：
  - 增加 `business` / `eventKey` 维度或做映射表；
  - 保留现有运营配置逻辑，仅补齐事件维度。
- 在成长域内部：
  - 事件按 `business + eventKey` 分发到对应子域；
  - 子域基于自身规则表匹配并执行，不做统一规则中心。

#### M4：论坛/漫画事件化接入

- forum：
  - 将“发帖/回帖/点赞”等成长入口改为：
    - 构造 `GrowthEventDto`；
    - 调用 `UserGrowthModule.handleEvent`；
  - 移除直接调用积分/经验/徽章服务的逻辑。
- comic：
  - 定义关键事件键（`comic.chapter.read`、`comic.chapter.buy` 等）；
  - 按相同方式上报成长事件；
  - 在各子域规则表中配置对应规则。

#### M5：管理端统一与审计能力暴露

- 新增 `/admin/user-growth/*` 接口：
  - 积分/经验/等级/徽章规则管理（增删改查、启停规则、调整限额与冷却时间）；
  - 用户成长视图（积分/经验/等级/徽章一体化查看）；
  - 事件审计查询（按 userId/eventKey/status 过滤）。
- 将 forum 侧成长配置与查询接口收口到 “用户成长管理” 下。

---

### 6. 验收标准

- 架构层面：
  - 所有新接入的成长逻辑必须通过 `UserGrowthModule.handleEvent` 并由各子域规则生效；
  - forum/comic 代码中不再存在对旧 `Forum*Service`（成长相关）的直接调用。
- 数据层面：
  - 徽章仅使用 `user_badge`、`user_badge_assignment` 新表，不保留旧表；
  - `user_growth_event` 能完整记录重要成长事件及其处理结果。
- 风控层面：
  - 对特定事件（如发帖）进行压测，确认防刷逻辑能有效限制高频行为；
  - 对高价值事件能明显降低“刷成长”的风险。
- 运维/运营层面：
  - 管理端可通过统一界面查看与调整各子域规则；
  - 可通过事件审计定位单个用户的成长异常。

---

### 7. 仍需你确认的细化歧义点

在上述共识基础上，仍存在少量细化问题需要后续确认或在设计阶段补充说明：

1. **防刷配置的管理维度**
  - 本方案约定“防刷阈值与高价值事件判定规则均为可配置”，但尚需明确：
    - 是通过各子域规则表承载，还是单独存在 `GrowthAntifraudConfig` 等专门表；
    - 管理端界面是集中在各子域规则管理中统一编辑，还是拆出一块“防刷策略管理”模块。

2. **高价值事件配置模型**
   - 高价值事件的判定将通过配置来实现，仍需确定：
     - 是否采用“按 eventKey + 阈值”方式配置（如单次积分>100 即视为高价值）；
     - 稀有徽章是否通过标签或单独字段标记为高价值，便于在配置中引用。

3. **事件审计数据的长期保留策略的实现形式**
   - 你已确认审计数据需要长期保留，本方案需要在设计阶段进一步明确：
     - 是通过单表长期保留，还是按时间分表/归档；
     - 是否需要针对 IP/设备等敏感字段做定期脱敏或访问控制。

4. **等级权益的具体业务数值**
   - 虽然本方案定义了等级权益的技术承载方式，且你已确认“不需要特殊等级”，但：
     - 每个等级具体对应的发帖数、回复数、点赞上限、黑名单/收藏上限等数值仍需业务方给出；
     - 等级变动时是否需要触发额外业务行为（如发送系统消息、运营通知）需在设计阶段进一步细化。

上述歧义点不会阻碍当前架构与数据模型的推进，但在进入详细 DESIGN 与实现阶段前，建议在配置模型与管理端设计中将这些问题一并澄清，使防刷与规则配置在保持“严格”的同时具备足够的灵活性与可运营性。 
