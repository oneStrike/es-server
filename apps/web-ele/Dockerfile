FROM node:22-slim AS builder

# é…ç½® pnpm ä¸ Node æ„å»ºç¯å¢ƒ
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV NODE_OPTIONS=--max-old-space-size=8192
ENV TZ=Asia/Shanghai

RUN npm i -g corepack

WORKDIR /app

# å¤åˆ¶æ•´ä¸ªå·¥ä½œåŒºï¼ˆ.dockerignore å·²è¿‡æ»¤ä¸å¿…è¦å†…å®¹ï¼‰
COPY . /app

# å®‰è£…ä¾èµ–ï¼ˆå¯ç”¨ pnpm ç¼“å­˜ï¼‰
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

# æ„å»ºï¼ˆæ’é™¤ docs ä»¥åŠ é€Ÿæ„å»ºï¼‰
RUN pnpm run build:ele --filter=\!./docs

# å…è®¸é€šè¿‡å‚æ•°é€‰æ‹©è¦éƒ¨ç½²çš„åº”ç”¨ç›®å½•ï¼Œé»˜è®¤éƒ¨ç½² Element Plus åº”ç”¨
ARG APP_PATH=apps/web-ele

# ç®€å•æ ¡éªŒæ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
RUN test -d "/app/${APP_PATH}/dist" || (echo "Build dist not found at /app/${APP_PATH}/dist" && ls -la "/app/${APP_PATH}" && exit 1)

RUN echo "Builder Success ğŸ‰"

FROM nginx:stable-alpine AS production
ARG APP_PATH=apps/web-ele
# é…ç½® nginx åŠ mjs MIME ç±»å‹
RUN echo "types { application/javascript js mjs; }" > /etc/nginx/conf.d/mjs.conf \
    && rm -rf /etc/nginx/conf.d/default.conf

# å¤åˆ¶æ„å»ºäº§ç‰©åˆ° nginx ç«™ç‚¹ç›®å½•
COPY --from=builder /app/${APP_PATH}/dist /usr/share/nginx/html

# ä½¿ç”¨é¡¹ç›®è‡ªå¸¦çš„ nginx é…ç½®
COPY --from=builder /app/scripts/deploy/nginx.conf /etc/nginx/nginx.conf

EXPOSE 8080

# å¯åŠ¨ nginx
CMD ["nginx", "-g", "daemon off;"]
