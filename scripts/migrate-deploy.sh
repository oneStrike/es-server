#!/bin/sh
# ========================================
# Prisma æ•°æ®åº“è¿ç§»éƒ¨ç½²è„šæœ¬
# ========================================
# ç”¨äºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ—¶è¿è¡Œæ•°æ®åº“è¿ç§»
# åœ¨å®¹å™¨å¯åŠ¨å‰æˆ–ä½œä¸ºåˆå§‹åŒ–å®¹å™¨è¿è¡Œ
# ========================================

set -e

echo "ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥..."

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
max_attempts=30
attempt=0

until npx prisma db execute --stdin <<< "SELECT 1;" > /dev/null 2>&1 || [ $attempt -eq $max_attempts ]; do
  attempt=$((attempt + 1))
  echo "â³ ç­‰å¾…æ•°æ®åº“è¿æ¥... (å°è¯• $attempt/$max_attempts)"
  sleep 2
done

if [ $attempt -eq $max_attempts ]; then
  echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¶…æ—¶é€€å‡º"
  exit 1
fi

echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ"

# è¿è¡Œæ•°æ®åº“è¿ç§»
echo "ğŸš€ å¼€å§‹æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
npx prisma migrate deploy

echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

# å¯é€‰ï¼šç”Ÿæˆ Prisma Clientï¼ˆæ„å»ºé˜¶æ®µå·²ç”Ÿæˆï¼Œæ­¤å¤„å¯çœç•¥ï¼‰
# echo "ğŸ“¦ ç”Ÿæˆ Prisma Client..."
# npx prisma generate

echo "ğŸ‰ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡å¯åŠ¨åº”ç”¨"
