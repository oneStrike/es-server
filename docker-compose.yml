networks:
  app-network:
    driver: bridge
  gitea-network:
    driver: bridge

volumes:
  gitea-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  gitea-runner-data:
    driver: local

services:
  # PostgreSQL 数据库服务 - 用于现有项目
  postgres:
    image: postgres:16-alpine
    container_name: es-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: [CMD-SHELL, 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis 缓存服务 - 用于现有项目
  redis:
    image: redis:7-alpine
    container_name: es-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - app-network
    healthcheck:
      test: [CMD, redis-cli, ping]
      interval: 30s
      timeout: 10s
      retries: 3

  # Gitea Git 代码仓库服务 - 独立服务
  gitea:
    image: docker.gitea.com/gitea:latest-rootless
    container_name: gitea-server
    restart: unless-stopped
    environment:
      # 用户和权限配置
      - USER_UID=${GITEA_USER_UID}
      - USER_GID=${GITEA_USER_GID}
      # 服务器配置
      - GITEA__server__ROOT_URL=${GITEA_ROOT_URL}
      - GITEA__server__SSH_LISTEN_PORT=2222
      - GITEA__server__SSH_PORT=${GITEA_SSH_PORT}
    volumes:
      - gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - '${GITEA_HTTP_PORT}:3000' # HTTP
      - '${GITEA_SSH_PORT}:2222' # SSH (rootless 镜像内部为 2222)
    networks:
      - gitea-network
    healthcheck:
      test: [CMD, curl, -f, 'http://localhost:3000/api/healthz']
      interval: 30s
      timeout: 10s
      retries: 2

  # Gitea Actions Runner
  gitea-runner:
    image: docker.io/gitea/act_runner:latest
    container_name: gitea-runner
    restart: unless-stopped
    depends_on:
      gitea:
        condition: service_healthy
    volumes:
      - gitea-runner-data:/data
      - ./gitea-runner-config.yaml:/data/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - GITEA_INSTANCE_URL=${GITEA_INSTANCE_URL}
      - GITEA_RUNNER_NAME=${GITEA_RUNNER_NAME}
      - GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_REGISTRATION_TOKEN}
      - CONFIG_FILE=/data/config.yaml
    networks:
      - gitea-network
