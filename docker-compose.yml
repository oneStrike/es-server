services:
  # PostgreSQL 数据库服务 - 用于现有项目
  postgres:
    image: postgres:16-alpine
    container_name: es-postgres
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    env_file:
      - ./.env
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_DB=${DB_NAME}
    networks:
      - app-network
    healthcheck:
      test: [CMD-SHELL, 'pg_isready -U "$DB_USER" -d "$DB_NAME"']
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 256M

  # Redis 缓存服务 - 用于现有项目
  redis:
    image: redis:7-alpine
    container_name: es-redis
    restart: unless-stopped
    command: sh -c 'redis-server --requirepass "$REDIS_PASSWORD" --appendonly yes'
    volumes:
      - redis-data:/data
    networks:
      - app-network
    env_file:
      - ./.env
    healthcheck:
      test: [CMD-SHELL, 'redis-cli -a "$REDIS_PASSWORD" ping']
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # Web 后端端服务
  admin-server:
    image: es/admin/server:0.0.2
    container_name: es-admin-server
    user: '1001:1001'
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - '8080:8080'
    env_file:
      - ./.env
      - ./.admin-server.env
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}
      - RSA_PRIVATE_KEY_PATH=/app/secrets/private.key
      - RSA_PUBLIC_KEY_PATH=/app/secrets/public.key
    volumes:
      - ./secrets:/app/secrets
      - uploads-data:/app/uploads
      - logs-data:/app/logs
    networks:
      - app-network
    logging: *default-logging
    healthcheck:
      test: [CMD-SHELL, 'wget --spider -q http://localhost:8080 || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 800M
        reservations:
          cpus: '0.1'
          memory: 256M

  # Web 后端端服务
  app-server:
    image: es/app/server:0.0.2
    container_name: es-app-server
    user: '1001:1001'
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - '8081:8080'
    env_file:
      - ./.env
      - ./.app-server.env
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}
      - RSA_PRIVATE_KEY_PATH=/app/secrets/private.key
      - RSA_PUBLIC_KEY_PATH=/app/secrets/public.key
    volumes:
      - ./secrets:/app/secrets
      - uploads-data:/app/uploads
      - logs-data:/app/logs
    networks:
      - app-network
    logging: *default-logging
    healthcheck:
      test: [CMD-SHELL, 'wget --spider -q http://localhost:8080 || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 800M
        reservations:
          cpus: '0.1'
          memory: 256M

  # Web 前端服务
  admin:
    image: es-admin:latest
    container_name: es-admin
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - '8082:8080'
    networks:
      - app-network
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M

networks:
  app-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  uploads-data:
    driver: local
  logs-data:
    driver: local

x-logging: &default-logging
  driver: json-file
  options:
    max-size: 10m
    max-file: '3'
