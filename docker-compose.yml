services:
  # Admin API 后端服务
  admin-server:
    image: es/admin/server:0.0.2
    container_name: es-admin-server
    # 强制只使用本地镜像，不拉取
    pull_policy: never
    user: '1001:1001'
    restart: unless-stopped
    # 日志轮转
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    # 依赖迁移服务
    depends_on:
      migrator:
        condition: service_completed_successfully
    # 安全选项
    security_opt:
      - no-new-privileges:true
    ports:
      # 使用环境变量控制端口映射，默认 8080
      - '${ADMIN_API_PORT}:8080'
    env_file:
      - ./.env
    environment:
      # 注入当前服务特定的配置
      - APP_NAME=admin-api
      # 如果代码中没有处理 DATABASE_URL 组合逻辑，则需在此显式声明
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      # 配置隔离映射
      - JWT_EXPIRATION_IN=${ADMIN_JWT_EXPIRATION_IN}
      - JWT_REFRESH_EXPIRATION_IN=${ADMIN_JWT_REFRESH_EXPIRATION_IN}
      - JWT_JWT_ISSUER=${ADMIN_JWT_ISSUER}
      - REDIS_NAMESPACE=${ADMIN_REDIS_NAMESPACE}
      - UPLOAD_DIR=${ADMIN_UPLOAD_DIR:-/app/uploads/admin}
      - UPLOAD_MAX_FILE_SIZE=${ADMIN_UPLOAD_MAX_FILE_SIZE}
      # 日志路径 (区分项目)
      - LOG_PATH=/app/logs/app
      # 控制台日志级别
      - LOG_CONSOLE_LEVEL=${LOG_CONSOLE_LEVEL}
    volumes:
      # 挂载上传和日志目录
      - ${HOST_UPLOADS_DIR:-es-server-uploads}:/app/uploads
      - ${HOST_LOGS_DIR:-es-server-logs}:/app/logs
      - /tmp # 使用匿名卷挂载临时目录，避免写入容器层
    networks:
      - app-network # 保留原有内部网络
      - 1panel-network # 新增：加入 1Panel 数据库网络（已对应真实网络）

  # 数据库迁移服务
  migrator:
    image: es/app/server:0.0.2
    container_name: es-migrator
    pull_policy: never
    user: '1001:1001'
    # 覆盖默认启动命令，执行迁移
    command: [bun, run, prisma, migrate, deploy, --schema, prisma/schema.prisma]
    # 任务执行完成后退出，不重启
    restart: no
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - 1panel-network

  # App API 后端服务
  app-server:
    image: es/app/server:0.0.2
    container_name: es-app-server
    # 强制只使用本地镜像，不拉取
    pull_policy: never
    user: '1001:1001'
    restart: unless-stopped
    # 日志轮转
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    # 依赖迁移服务
    depends_on:
      migrator:
        condition: service_completed_successfully
    # 安全选项
    security_opt:
      - no-new-privileges:true
    ports:
      # 使用环境变量控制端口映射，默认 8081
      - '${APP_API_PORT}:8080'
    env_file:
      - ./.env
    environment:
      - APP_NAME=app-api
      - APP_PORT=8080
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      # 配置隔离映射
      - JWT_EXPIRATION_IN=${APP_JWT_EXPIRATION_IN}
      - JWT_REFRESH_EXPIRATION_IN=${APP_JWT_REFRESH_EXPIRATION_IN}
      - JWT_JWT_ISSUER=${APP_JWT_ISSUER}
      - UPLOAD_DIR=${APP_UPLOAD_DIR:-/app/uploads/app}
      - UPLOAD_MAX_FILE_SIZE=${APP_UPLOAD_MAX_FILE_SIZE}
      - REDIS_NAMESPACE=${APP_REDIS_NAMESPACE}
      - APP_VERSION=${APP_APP_VERSION}
      - APP_FILE_URL_PREFIX=${APP_APP_FILE_URL_PREFIX}
      # 日志路径 (区分项目)
      - LOG_PATH=/app/logs/app
      # 控制台日志级别
      - LOG_CONSOLE_LEVEL=${LOG_CONSOLE_LEVEL}
    volumes:
      - ${HOST_UPLOADS_DIR:-es-server-uploads}:/app/uploads
      - ${HOST_LOGS_DIR:-es-server-logs}:/app/logs
      - /tmp
    networks:
      - app-network # 保留原有内部网络
      - 1panel-network # 新增：加入 1Panel 数据库网络（已对应真实网络）

  # Web 前端服务
  admin:
    image: es-admin-web-ele:latest
    container_name: es-admin
    # 强制只使用本地镜像，不拉取
    pull_policy: never
    restart: unless-stopped
    # 日志轮转
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    ports:
      # 使用环境变量控制端口映射，默认 8082
      - '${ADMIN_PORT}:8080'
    networks:
      - app-network # 前端无需访问数据库，仅保留内部网络即可

  # Web App服务
  app:
    image: es-app-web:latest
    container_name: es-app
    # 强制只使用本地镜像，不拉取
    pull_policy: never
    restart: unless-stopped
    # 日志轮转
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    ports:
      # 使用环境变量控制端口映射，默认 8082
      - '${APP_WEB_PORT}:8080'
    networks:
      - app-network # 前端无需访问数据库，仅保留内部网络即可

networks:
  app-network:
    driver: bridge
  # 新增：1Panel 外部网络（已替换为 1Panel 默认真实网络名称 1panel-network）
  1panel-network:
    external: true
    name: 1panel-network # 若你的 1Panel 网络名称不是这个，替换为自己查到的

volumes:
  es-server-logs:
    driver: local
  es-server-uploads:
    driver: local
