services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    hostname: gitlab
    ports:
      - '7070:80'
      - '2222:22'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://weacgn.com:7070'
        nginx['listen_https'] = true
        gitlab_rails['backup_path'] = '/var/opt/gitlab/backups'
    restart: always
    # GitLab 使用自带的内置 PostgreSQL/Redis，不依赖外部服务
    volumes:
      - gitlab-config:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - gitlab-data:/var/opt/gitlab

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-gitlab}
      POSTGRES_USER: ${POSTGRES_USER:-es}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    restart: always
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [CMD-SHELL, 'pg_isready -U ${POSTGRES_USER:-es}']
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis
    command:
      - redis-server
      - --appendonly
      - yes
      - --appendfsync
      - everysec
      - --requirepass
      - '${REDIS_PASSWORD:?REDIS_PASSWORD is required}'
      - --bind
      - 0.0.0.0
      - --protected-mode
      - yes

    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    restart: always
    volumes:
      - redis-data:/data
    healthcheck:
      test: [CMD-SHELL, 'redis-cli -a $$REDIS_PASSWORD ping || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5

  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: ${GITLAB_RUNNER_CONTAINER_NAME:-gitlab-runner}
    restart: always
    depends_on:
      - gitlab
    environment:
      - DOCKER_TLS_CERTDIR=
    volumes:
      - runner-config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  gitlab-config:
  gitlab-logs:
  gitlab-data:
  postgres-data:
  redis-data:
  runner-config:
