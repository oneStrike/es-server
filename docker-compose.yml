x-logging: &default-logging
  driver: json-file
  options:
    max-size: 10m
    max-file: '3'

services:
  # PostgreSQL 数据库服务
  postgres:
    image: postgres:16-alpine
    container_name: es-postgres
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    env_file:
      - ./.env
    environment:
      # 显式映射变量以确保 Postgres 镜像能正确读取
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_DB=${DB_NAME}
    networks:
      - app-network
    healthcheck:
      test: [CMD-SHELL, 'pg_isready -U "$DB_USER" -d "$DB_NAME"']
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 256M

  # Redis 缓存服务
  redis:
    image: redis:7-alpine
    container_name: es-redis
    restart: unless-stopped
    # 使用环境变量中的密码启动
    command: sh -c 'redis-server --requirepass "$REDIS_PASSWORD" --appendonly yes'
    volumes:
      - redis-data:/data
    networks:
      - app-network
    env_file:
      - ./.env
    healthcheck:
      test: [CMD-SHELL, 'redis-cli -a "$REDIS_PASSWORD" ping']
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # Admin API 后端服务
  admin-server:
    image: es/admin/server:0.0.2
    build:
      context: .
      dockerfile: apps/admin-api/Dockerfile
    container_name: es-admin-server
    # 强制只使用本地镜像，不拉取
    pull_policy: never
    user: '1001:1001'
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      # 使用环境变量控制端口映射，默认 8080
      - '${ADMIN_API_PORT}:8080'
    env_file:
      - ./.env
    environment:
      # 注入当前服务特定的配置
      - APP_NAME=admin-api
      # 如果代码中没有处理 DATABASE_URL 组合逻辑，则需在此显式声明
      - DATABASE_URL=${DATABASE_URL}
      # 配置隔离映射
      - JWT_EXPIRATION_IN=${ADMIN_JWT_EXPIRATION_IN}
      - JWT_REFRESH_EXPIRATION_IN=${ADMIN_JWT_REFRESH_EXPIRATION_IN}
      - JWT_JWT_ISSUER=${ADMIN_JWT_ISSUER}
      - REDIS_NAMESPACE=${ADMIN_REDIS_NAMESPACE}
      - UPLOAD_DIR=${ADMIN_UPLOAD_DIR:-/app/uploads/admin}
      - UPLOAD_MAX_FILE_SIZE=${ADMIN_UPLOAD_MAX_FILE_SIZE}
    volumes:
      # 挂载上传和日志目录
      - ${HOST_UPLOADS_DIR:-./data/uploads}:/app/uploads
      - ${HOST_LOGS_DIR:-./data/logs}:/app/logs
    networks:
      - app-network
    logging: *default-logging
    healthcheck:
      test: [CMD-SHELL, 'wget --spider -q http://localhost:8080 || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 800M
        reservations:
          cpus: '0.1'
          memory: 256M

  # App API 后端服务
  app-server:
    image: es/app/server:0.0.2
    build:
      context: .
      dockerfile: apps/app-api/Dockerfile
    container_name: es-app-server
    # 强制只使用本地镜像，不拉取
    pull_policy: never
    user: '1001:1001'
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      # 使用环境变量控制端口映射，默认 8081
      - '${APP_API_PORT}:8080'
    env_file:
      - ./.env
    environment:
      - APP_NAME=app-api
      - APP_PORT=8080
      - DATABASE_URL=${DATABASE_URL}
      # 配置隔离映射
      - JWT_EXPIRATION_IN=${APP_JWT_EXPIRATION_IN}
      - JWT_REFRESH_EXPIRATION_IN=${APP_JWT_REFRESH_EXPIRATION_IN}
      - JWT_JWT_ISSUER=${APP_JWT_ISSUER}
      - UPLOAD_DIR=${APP_UPLOAD_DIR:-/app/uploads/app}
      - UPLOAD_MAX_FILE_SIZE=${APP_UPLOAD_MAX_FILE_SIZE}
      - REDIS_NAMESPACE=${APP_REDIS_NAMESPACE}
      - APP_VERSION=${APP_APP_VERSION}
      - APP_FILE_URL_PREFIX=${APP_APP_FILE_URL_PREFIX}
    volumes:
      - ${HOST_UPLOADS_DIR:-./data/uploads}:/app/uploads
      - ${HOST_LOGS_DIR:-./data/logs}:/app/logs
    networks:
      - app-network
    logging: *default-logging
    healthcheck:
      test: [CMD-SHELL, 'wget --spider -q http://localhost:8080 || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 800M
        reservations:
          cpus: '0.1'
          memory: 256M

  # Web 前端服务
  admin:
    image: es-admin-web-ele:latest
    container_name: es-admin
    # 强制只使用本地镜像，不拉取
    pull_policy: never
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      # 使用环境变量控制端口映射，默认 8082
      - '${ADMIN_PORT}:8080'
    networks:
      - app-network
    logging: *default-logging
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M

networks:
  app-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
