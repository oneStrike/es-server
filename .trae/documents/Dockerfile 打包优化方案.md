# Dockerfile 打包优化方案（保留 PM2）

## 1. 优化分析

### 1.1 打包速度优化点
- **构建范围过大**：当前使用 `pnpm build:all` 构建所有应用，而实际上只需要构建 `admin-api`
- **依赖安装可以更精准**：可以使用 pnpm 的 `--filter` 选项仅安装 admin-api 相关依赖
- **构建工具可以更高效**：项目已安装 SWC，可以配置 NestJS 使用 SWC 加速构建

### 1.2 打包大小优化点
- **不必要的构建产物**：构建了 client-api 但未使用
- **运行时依赖冗余**：安装了 wget，可考虑更轻量的替代方案
- **文件复制过于宽泛**：复制了整个项目目录，包含许多不必要的文件
- **Prisma 文件处理**：复制了整个 prisma 目录，可精简

## 2. 优化方案

### 2.1 打包速度优化

1. **仅构建 admin-api**
   - 将 `pnpm build:all` 改为 `pnpm build:admin`
   - 减少不必要的构建时间

2. **精准安装依赖**
   - 使用 `pnpm install --frozen-lockfile --filter admin-api`
   - 仅安装 admin-api 相关依赖，减少安装时间和空间

3. **配置 SWC 加速构建**
   - 在 nest-cli.json 中配置 SWC 作为编译器
   - 显著提升 TypeScript 编译速度

### 2.2 打包大小优化

1. **精简文件复制**
   - 仅复制 admin-api 和共享库相关文件
   - 避免复制不必要的应用和测试文件

2. **优化运行时依赖**
   - 使用 curl 替代 wget（更轻量）
   - 保留 PM2 作为进程管理器

3. **优化 Prisma 处理**
   - 仅复制必要的 Prisma 文件（schema.prisma 和 migrations）
   - 减少不必要的文件复制

4. **使用更轻量的基础镜像**
   - 继续使用 `node:22-alpine`，这是一个轻量的基础镜像

5. **优化多阶段构建**
   - 在构建阶段更精细地控制文件复制
   - 在运行时阶段仅复制必要的文件

## 3. 具体修改点

### 3.1 修改 Dockerfile

1. **构建阶段优化**
   - 将 `pnpm build:all` 改为 `pnpm build:admin`
   - 仅构建 admin-api，减少构建时间

2. **运行时阶段优化**
   - 使用 curl 替代 wget（更轻量）
   - 保留 PM2 相关配置
   - 仅复制必要的 Prisma 文件

3. **健康检查优化**
   - 使用 curl 替代 wget 进行健康检查

### 3.2 配置文件修改

1. **nest-cli.json 配置 SWC**
   - 配置 SWC 作为编译器，加速 TypeScript 编译

## 4. 预期效果

### 4.1 打包速度提升
- 构建时间预计减少 40% 以上（仅构建单个应用）
- 依赖安装时间预计减少 30% 以上
- 编译速度预计提升 2-3 倍（使用 SWC）

### 4.2 打包大小优化
- 镜像大小预计减少 20-30%（移除不必要的依赖和文件）
- 启动时间预计减少 10% 以上
- 内存占用预计减少 15% 以上

## 5. 实施步骤

1. 修改 Dockerfile，实施构建速度和大小优化
2. 配置 SWC 加速构建
3. 测试优化后的镜像，确保功能正常
4. 对比优化前后的构建时间和镜像大小
5. 根据测试结果进行微调

## 6. 风险评估

1. **SWC 兼容性**：需确保 SWC 与当前 NestJS 版本兼容
2. **依赖精简风险**：需确保移除的依赖不会影响应用功能
3. **文件复制精简风险**：需确保所有必要文件都被正确复制

## 7. 验收标准

1. **功能正常**：优化后的镜像能正常启动和运行 admin-api
2. **构建速度提升**：构建时间减少 30% 以上
3. **镜像大小减少**：镜像大小减少 20% 以上
4. **启动时间减少**：容器启动时间减少 10% 以上
5. **内存占用减少**：运行时内存占用减少 15% 以上
6. **PM2 功能保留**：PM2 进程管理功能正常工作
