name: Build and Package

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - master

jobs:
  docker-build:
    runs-on: es
    env:
      NODE_VERSION: '22'
      IMAGE_NAME: es-server
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: è®¾ç½®é•œåƒæ ‡ç­¾ä¸å®¹å™¨å
        id: vars
        run: |
          set -e
          PKG_VERSION=$(node -p "require('./package.json').version || ''")
          IMAGE_TAG="$PKG_VERSION"
          if [ -z "$IMAGE_TAG" ]; then IMAGE_TAG=latest; fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "CANDIDATE_TAG=${IMAGE_TAG}-candidate" >> $GITHUB_ENV
          echo "CONTAINER_NAME=${IMAGE_NAME}-${IMAGE_TAG}-candidate" >> $GITHUB_ENV

      # ä¸å†åœ¨æ„å»ºå‰åˆ é™¤åŒåé•œåƒï¼Œé¿å…æ„å»ºå¤±è´¥å¯¼è‡´é•œåƒç¼ºå¤±

      - name: æ‰“åŒ…é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          tags: ${{ env.IMAGE_NAME }}:${{ env.CANDIDATE_TAG }}
          cache-from: type=local,src=/data/cache/server/buildx
          cache-to: type=local,dest=/data/cache/server/buildx,mode=max
          load: true

      - name: è¿è¡Œé•œåƒ
        run: |
          set -e
          docker run -d --name "${{ env.CONTAINER_NAME }}" \
            -e NODE_ENV=production \
            -e PORT=8080 \
            ${{ env.IMAGE_NAME }}:${{ env.CANDIDATE_TAG }}

          echo "â³ æ­£åœ¨ç­‰å¾…å®¹å™¨å¥åº·ï¼ˆDocker HEALTHCHECKï¼‰..."
          ATTEMPTS=10
          SLEEP_SECONDS=6
          PASSED=""
          for i in $(seq 1 $ATTEMPTS); do
            STATUS=$(docker inspect --format='{{.State.Status}}' "${{ env.CONTAINER_NAME }}")
            HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}no-healthcheck{{end}}' "${{ env.CONTAINER_NAME }}")
            if [ "$STATUS" != "running" ]; then
              echo "ğŸ“¦ å®¹å™¨çŠ¶æ€ï¼š$STATUS"
              echo "âŒ å®¹å™¨æå‰é€€å‡ºï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
              docker logs "${{ env.CONTAINER_NAME }}" || true
              exit 1
            fi
            if [ "$HEALTH" = "healthy" ]; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
              PASSED="yes"
              break
            fi
            echo "ğŸ©º å¥åº·çŠ¶æ€=$HEALTHï¼Œé‡è¯• $i/$ATTEMPTS"
            sleep $SLEEP_SECONDS
          done

          if [ -z "$PASSED" ]; then
            echo "â›” å®¹å™¨æœªåœ¨é¢„æœŸæ—¶é—´å†…å˜ä¸ºå¥åº·ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
            docker logs "${{ env.CONTAINER_NAME }}" || true
            exit 1
          fi

      - name: è¦†ç›–æ­£å¼æ ‡ç­¾ï¼ˆå€™é€‰é•œåƒå¥åº·åï¼‰
        run: |
          set -e
          docker tag "${{ env.IMAGE_NAME }}:${{ env.CANDIDATE_TAG }}" "${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

      - name: æ¸…ç†å€™é€‰å®¹å™¨ä¸é•œåƒ
        if: always()
        run: |
          docker rm -f "${{ env.CONTAINER_NAME }}" || true
          docker rmi -f "${{ env.IMAGE_NAME }}:${{ env.CANDIDATE_TAG }}" || true
