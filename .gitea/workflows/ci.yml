name: Build and Package

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - master

jobs:
  docker-build:
    runs-on: es
    env:
      NODE_VERSION: '22'
      IMAGE_NAME: es-server
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 清理使用旧镜像的容器（若存在）
        run: |
          set -e
          IMAGE_TAG="${{ env.IMAGE_NAME }}:latest"
          CONTAINERS=$(docker ps -a --filter "ancestor=${IMAGE_TAG}" -q || true)
          if [ -n "$CONTAINERS" ]; then
            echo "Found containers using ${IMAGE_TAG}. Removing them..."
            docker rm -f $CONTAINERS || true
          else
            echo "No containers are using ${IMAGE_TAG}."
          fi

      - name: 替换已有镜像（若存在）
        run: |
          set -e
          REPO="${{ env.IMAGE_NAME }}"
          # 移除该仓库下所有相关标签的镜像，避免旧镜像残留导致 <none> 镜像
          IMAGES=$(docker images --filter="reference=${REPO}:*" -q | sort -u)
          if [ -n "$IMAGES" ]; then
            echo "Found existing images for ${REPO}. Removing all related tags..."
            docker rmi -f $IMAGES || true
          else
            echo "No existing images for ${REPO}. Proceeding with normal build."
          fi

      - name: 打包镜像
        id: build_image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          tags: ${{ env.IMAGE_NAME }}:latest
          cache-from: type=local,src=/data/cache/server/buildx
          cache-to: type=local,dest=/data/cache/server/buildx,mode=max
          load: true

      - name: 构建后清理悬空镜像
        run: |
          # 清理构建过程中产生的悬空镜像，避免出现 <none> 标签占用空间
          docker image prune -f || true